<!DOCTYPE html>
<html lang="en">
<head>

    <title>Vue 札记</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" type="text/css" href="../assets/built/screen.css%3Fv=3a5c6e94d3.css" />

    <meta name="description" content="Vue2 &#x3D;&gt; JavaScript Framework">
    <link rel="icon" href="../content/images/size/w256h256/2021/07/ghost-orb.png" type="image/png">
    <link rel="canonical" href="index.html">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <link rel="amphtml" href="amp/index.html">
    
    <meta property="og:site_name" content="zairesinatra">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Vue 札记">
    <meta property="og:description" content="Vue2 &#x3D;&gt; JavaScript Framework">
    <meta property="og:url" content="https://zairesinatra.github.io//vuebugs/">
    <meta property="og:image" content="https://zairesinatra.github.io//content/images/2022/07/ShirahigeJinja.jpg">
    <meta property="article:published_time" content="2020-12-14T12:21:00.000Z">
    <meta property="article:modified_time" content="2023-06-16T14:13:04.000Z">
    <meta property="article:tag" content="Technology growth">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Vue 札记">
    <meta name="twitter:description" content="Vue2 &#x3D;&gt; JavaScript Framework">
    <meta name="twitter:url" content="https://zairesinatra.github.io//vuebugs/">
    <meta name="twitter:image" content="https://zairesinatra.github.io//content/images/2022/07/ShirahigeJinja.jpg">
    <meta name="twitter:label1" content="Written by">
    <meta name="twitter:data1" content="Ziyi Xie">
    <meta name="twitter:label2" content="Filed under">
    <meta name="twitter:data2" content="Technology growth">
    <meta name="twitter:site" content="@xieziyi0422">
    <meta property="og:image:width" content="1920">
    <meta property="og:image:height" content="1080">
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "zairesinatra",
        "url": "https://zairesinatra.github.io//",
        "logo": {
            "@type": "ImageObject",
            "url": "https://zairesinatra.github.io//content/images/2021/07/zs-1.JPG",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ziyi Xie",
        "image": {
            "@type": "ImageObject",
            "url": "https://zairesinatra.github.io//content/images/2021/07/zs-2.JPG",
            "width": 1079,
            "height": 1079
        },
        "url": "https://zairesinatra.github.io//author/ziyi/",
        "sameAs": []
    },
    "headline": "Vue 札记",
    "url": "https://zairesinatra.github.io//vuebugs/",
    "datePublished": "2020-12-14T12:21:00.000Z",
    "dateModified": "2023-06-16T14:13:04.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://zairesinatra.github.io//content/images/2022/07/ShirahigeJinja.jpg",
        "width": 1920,
        "height": 1080
    },
    "keywords": "Technology growth",
    "description": "Vue2 &#x3D;&gt; JavaScript Framework",
    "mainEntityOfPage": "https://zairesinatra.github.io//vuebugs/"
}
    </script>

    <meta name="generator" content="Ghost 5.53">
    <link rel="alternate" type="application/rss+xml" title="zairesinatra" href="../rss/index.html">
    <script defer src="https://cdn.jsdelivr.net/ghost/portal@~2.33/umd/portal.min.js" data-i18n="false" data-ghost="https://zairesinatra.github.io//" data-key="f5d74add11f1d16d3e59c12945" data-api="https://zairesinatra.github.io//ghost/api/content/" crossorigin="anonymous"></script><style id="gh-members-styles">.gh-post-upgrade-cta-content,
.gh-post-upgrade-cta {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    text-align: center;
    width: 100%;
    color: #ffffff;
    font-size: 16px;
}

.gh-post-upgrade-cta-content {
    border-radius: 8px;
    padding: 40px 4vw;
}

.gh-post-upgrade-cta h2 {
    color: #ffffff;
    font-size: 28px;
    letter-spacing: -0.2px;
    margin: 0;
    padding: 0;
}

.gh-post-upgrade-cta p {
    margin: 20px 0 0;
    padding: 0;
}

.gh-post-upgrade-cta small {
    font-size: 16px;
    letter-spacing: -0.2px;
}

.gh-post-upgrade-cta a {
    color: #ffffff;
    cursor: pointer;
    font-weight: 500;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a:hover {
    color: #ffffff;
    opacity: 0.8;
    box-shadow: none;
    text-decoration: underline;
}

.gh-post-upgrade-cta a.gh-btn {
    display: block;
    background: #ffffff;
    text-decoration: none;
    margin: 28px 0 0;
    padding: 8px 18px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 600;
}

.gh-post-upgrade-cta a.gh-btn:hover {
    opacity: 0.92;
}</style>
    <script defer src="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/sodo-search.min.js" data-key="f5d74add11f1d16d3e59c12945" data-styles="https://cdn.jsdelivr.net/ghost/sodo-search@~1.1/umd/main.css" data-sodo-search="https://zairesinatra.github.io//" crossorigin="anonymous"></script>
    
    <link href="https://zairesinatra.github.io//webmentions/receive/" rel="webmention">
    <script defer src="../public/cards.min.js%3Fv=3a5c6e94d3"></script>
    <link rel="stylesheet" type="text/css" href="../public/cards.min.css%3Fv=3a5c6e94d3.css">
    <script defer src="../public/member-attribution.min.js%3Fv=3a5c6e94d3"></script>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-NXZH6Q3K52"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-NXZH6Q3K52');
</script>

<!-- Ghost Init -->
<style>
.post-template .gh-head,
.page-template .gh-head {
  background: #000000 !important;
}
.site-footer {
  background: #000000 !important;
}
.post-card-tags {
  color: var(--color-secondary-text) !important;
}
.gh-portal-triggerbtn-container.with-label::before {
  display: none !important;
}
/* 需提前，否则闪烁 */
.footer-cta,
a.gh-head-button {
  display: none;
}
.algoliaouterwrapper i svg {
  width: 0;
}
/* 更多内容去除外边距 */
.footer-cta + .read-more-wrap {
  margin-top: unset;
}
</style>

<!-- Resize Pre Area in PrismJS -->
<style>
    pre[class*="language-"].line-numbers{
		font-size: 0.8em;
        background-color: #202324;
    }
    code[class*="language-"] {
        background-color: transparent !important;
    }
</style>

<!-- TOC -->
<style>
    .toc > .toc-list li:first-child {
      margin-top: 8px;
    }
    .toc-list a {
      color: #000000 !important;
      text-decoration: none;
      word-break: break-word;
    }
    .toc > ol, .toc > li{
      font-size: 1.4rem;
    }
    
    .toc.active > .toc-list li:first-child {
      margin-top: 8px;
    }
    .toc.active .toc-list a {
      color: #FFFFFF !important;
      text-decoration: none;
      word-break: break-word;
    }
    .toc.active > ol, .toc.active > li{
      font-size: 1.4rem;
    }
</style>

<!-- ghost style by wkzs -->
<style>
.gh-content > [id]:not(:first-child) {
  margin: 1.5em 0 0;
}
.gh-content > hr + *, .gh-content > blockquote + * {
  margin-top: max(1.1rem, 16px) !important;
}
.gh-content > [id]:not(:first-child) {
  margin: 1em 0 0;
}
.gh-content > * + * {
  margin-top: max(1.6vmin, 16px);
  margin-bottom: 0;
}
.gh-content > blockquote:not([class]), .gh-content > ol, .gh-content > ul, .gh-content > dl, .gh-content > p {
    font-family: var(--font-serif);
    font-weight: 400;
    font-size: 1.4rem !important;
  	line-height: 1.8em !important;
    margin-top: 1.6rem;
}
</style>

<!-- Theme Change -->
<style>
@keyframes slideUp {
  from {
    bottom: 100px;
    opacity: 0;
  }
  to {
    bottom: 0;
    opacity: 1;
  }
}
.theme-switcher-wrap {
  width: 42px;
  height: 24px;
  text-align: right;
}
@media (max-width: 767px) {
  .gh-head-open .theme-switcher-wrap {
    width: 42px;
    height: 24px;
    text-align: right;
    animation: slideUp 1s ease-in-out forwards;
  }
}
.theme-switcher {
  display: inline-block;
  cursor: pointer;
}
.switch-path {
  width: 42px;
  height: 24px;
  border-radius: 10px;
  background-color: #f2f2f2;
  border: #dddfe6 1px solid;
}
.switch-path > .switch-handle {
  background-color: #ffffff;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  transition: all 0.3s ease-in-out;
}
.switch-handle .dark-icon {
  visibility: hidden;
  display: none;
}
.theme-switcher.active .switch-path {
  background-color: #555;
}
.theme-switcher.active .switch-handle {
  transform: translateX(20px);
  background-color: #101115;
}
.theme-switcher.active .switch-handle .light-icon {
  visibility: hidden;
}
.theme-switcher.active .switch-handle .dark-icon {
  visibility: visible;
  display: block;
}
</style>

<!-- Drak Theme Ghost CSS -->
<style>
.dark-mode .gh-content > blockquote:not([class])::before {
  background: #FFFFFF !important;
}
</style>

<!-- Arrow up -->
<style>
.arrowup {
  position: fixed;
  width: 50px;
  height: 50px;
  left: 35px;
  bottom: 3.1rem;
  z-index: 99;
  background-color: #15171a;
  display: flex;
  justify-content: center;
  align-items: center;
  border-radius: 10px;
  cursor: pointer;
  display: none;
}
.arrowup svg {
  fill: #ffffff;
}
.arrowup:hover {
  opacity: 0.8;
}
</style>

<!-- 2023 => prismjs -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zairesinatra/GhostCDN@1.0.0/prism.css"/>

<!-- tocbot -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.css">

<!-- docsearch -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@docsearch/css@3"/></pre></li><style>:root {--ghost-accent-color: #15171A;}</style>

</head>
<body class="post-template tag-technology-growth is-head-left-logo has-cover">
<div class="viewport">

    <header id="gh-head" class="gh-head outer">
        <div class="gh-head-inner inner">
            <div class="gh-head-brand">
                <a class="gh-head-logo" href="../index.html">
                        <img src="../content/images/2021/07/zs-1.JPG" alt="zairesinatra">
                </a>
                <button class="gh-search gh-icon-btn" onclick="docSearchFuncMobile()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                <button class="gh-burger"></button>
            </div>

            <nav class="gh-head-menu">
                <ul class="nav">
    <li class="nav-home"><a href="../index.html">Home</a></li>
    <li class="nav-welcome"><a href="../welcome/index.html">Welcome</a></li>
    <li class="nav-author"><a href="../selfintro/index.html">Author</a></li>
    <li class="nav-tags"><a href="../tags/index.html">Tags</a></li>
</ul>

            </nav>

            <div class="gh-head-actions">
                <div class="gh-head-actions">
                    <div class="theme-switcher-wrap">
                    <div class="theme-switcher" onclick="switchTheme()">
                        <div class="switch-path">
                        <div class="switch-handle">
                            <svg viewBox="0 0 24 24" class="dark-icon">
                            <path
                                d="M11.01 3.05C6.51 3.54 3 7.36 3 12a9 9 0 0 0 9 9c4.63 0 8.45-3.5 8.95-8c.09-.79-.78-1.42-1.54-.95A5.403 5.403 0 0 1 11.1 7.5c0-1.06.31-2.06.84-2.89c.45-.67-.04-1.63-.93-1.56z"
                                fill="#CFD3DC"
                            ></path>
                            </svg>
                            <svg viewBox="0 0 24 24" class="light-icon">
                            <path
                                d="M6.05 4.14l-.39-.39a.993.993 0 0 0-1.4 0l-.01.01a.984.984 0 0 0 0 1.4l.39.39c.39.39 1.01.39 1.4 0l.01-.01a.984.984 0 0 0 0-1.4zM3.01 10.5H1.99c-.55 0-.99.44-.99.99v.01c0 .55.44.99.99.99H3c.56.01 1-.43 1-.98v-.01c0-.56-.44-1-.99-1zm9-9.95H12c-.56 0-1 .44-1 .99v.96c0 .55.44.99.99.99H12c.56.01 1-.43 1-.98v-.97c0-.55-.44-.99-.99-.99zm7.74 3.21c-.39-.39-1.02-.39-1.41-.01l-.39.39a.984.984 0 0 0 0 1.4l.01.01c.39.39 1.02.39 1.4 0l.39-.39a.984.984 0 0 0 0-1.4zm-1.81 15.1l.39.39a.996.996 0 1 0 1.41-1.41l-.39-.39a.993.993 0 0 0-1.4 0c-.4.4-.4 1.02-.01 1.41zM20 11.49v.01c0 .55.44.99.99.99H22c.55 0 .99-.44.99-.99v-.01c0-.55-.44-.99-.99-.99h-1.01c-.55 0-.99.44-.99.99zM12 5.5c-3.31 0-6 2.69-6 6s2.69 6 6 6s6-2.69 6-6s-2.69-6-6-6zm-.01 16.95H12c.55 0 .99-.44.99-.99v-.96c0-.55-.44-.99-.99-.99h-.01c-.55 0-.99.44-.99.99v.96c0 .55.44.99.99.99zm-7.74-3.21c.39.39 1.02.39 1.41 0l.39-.39a.993.993 0 0 0 0-1.4l-.01-.01a.996.996 0 0 0-1.41 0l-.39.39c-.38.4-.38 1.02.01 1.41z"
                                fill="#606266"
                            ></path>
                            </svg>
                        </div>
                        </div>
                    </div>
                    </div>
                </div>
                    <button class="gh-search gh-icon-btn" onclick="docSearchFuncMobile()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button>
                    <div class="gh-head-members">
                                <a class="gh-head-link" href="index.html#/portal/signin" data-portal="signin">Sign in</a>
                                <a class="gh-head-button" href="index.html#/portal/signup" data-portal="signup">Subscribe</a>
                    </div>
            </div>
        </div>
    </header>

    <div class="site-content">
        



<main id="site-main" class="site-main">
<article class="article post tag-technology-growth ">

    <header class="article-header gh-canvas">

        <div class="article-tag post-card-tags">
                <span class="post-card-primary-tag">
                    <a href="../tag/technology-growth/index.html">Technology growth</a>
                </span>
        </div>

        <h1 class="article-title">Vue 札记</h1>

            <p class="article-excerpt">Vue2 &#x3D;&gt; JavaScript Framework</p>

        <div class="article-byline">
        <section class="article-byline-content">

            <ul class="author-list">
                <li class="author-list-item">
                    <a href="../author/ziyi/index.html" class="author-avatar">
                        <img class="author-profile-image" src="../content/images/size/w100/2021/07/zs-2.JPG" alt="Ziyi Xie" />
                    </a>
                </li>
            </ul>

            <div class="article-byline-meta">
                <h4 class="author-name"><a href="../author/ziyi/index.html">Ziyi Xie</a></h4>
                <div class="byline-meta-content">
                    <time class="byline-meta-date" datetime="2020-12-14">Dec 14, 2020</time>
                        <span class="byline-reading-time"><span class="bull">&bull;</span> 15 min read</span>
                </div>
            </div>

        </section>
        </div>

            <figure class="article-image">
                <img
                    srcset="../content/images/size/w2000/2022/07/ShirahigeJinja.jpg 2000w"
                    sizes="(min-width: 1400px) 1400px, 92vw"
                    src="../content/images/size/w2000/2022/07/ShirahigeJinja.jpg"
                    alt="Shirahige Jinja"
                />
                    <figcaption><b>Shirahige Jinja</b></figcaption>
            </figure>

    </header>

    <section class="gh-content gh-canvas">
        <aside class="toc-container">
            <div class="toc"></div>
        </aside>
        <!--kg-card-begin: markdown--><h2 id="basicconcepts">Basic Concepts</h2>
<h3 id="templatecompilation">Template Compilation</h3>
<p>模板编译是指将 Vue Template Syntax 转换为可执行的 JavaScript 渲染函数的过程，这个渲染函数通常被命名为 <code>render</code> 函数。<code>render</code> 函数中可以使用 <a href="https://github.com/Matt-Esch/virtual-dom/blob/master/vdom/create-element.js?ref=localhost"><code>createElement</code></a> 辅助函数（用于创建虚拟 DOM 节点）来描述组件的渲染结构。</p>
<p>Vue 中 <code>h</code> 函数是 <code>createElement</code> 函数的 ES6 语法缩写，源自 <a href="https://github.com/Matt-Esch/virtual-dom/blob/master/virtual-hyperscript/README.md?ref=localhost">virtual-dom</a> 中的 <a href="https://github.com/hyperhype/hyperscript?ref=localhost">hyperscript</a> 脚本。</p>
<pre><code class="language-javascript">render: function(createElement){ return createElement(App) }
const h = (tag, props, children) =&gt; {return {tag, props, children,...}}
render: h =&gt; h(App)
</code></pre>
<h3 id="architecturalpatterns">Architectural Patterns</h3>
<p>MVC 与 MVVM 都实现了数据、视图和业务逻辑的分离，但在角色和数据流方面有一些区别：</p>
<ul>
<li>Model-View-Controller 中，数据流是单向的。控制器接收用户输入，更新模型数据，然后通知视图进行更新。</li>
<li>Model-View-ViewModel 中，虽然视图和模型不会直接通信，但是数据流是双向的。视图与模型之间会通过视图模型来进行自动更新。</li>
</ul>
<h3 id="datahijackingproxy">Data Hijacking &amp; Proxy</h3>
<p>数据劫持是当对象的属性被访问或赋值时，将会触发预定义的方法，从而可以在这些方法中进行相应的操作，比如依赖收集和派发更新通知。</p>
<p>数据代理是在实例化期间，将数据对象的属性定义为实例上的访问器属性，当访问或赋值实例上的属性时，实际上是在访问或赋值数据对象上的对应属性。这种方式可以简化访问和绑定数据的语法。</p>
<p><img src="https://res.cloudinary.com/dzb9ldnvl/image/upload/v1686921937/blog/zsghost/Vue%20%E6%9C%AD%E8%AE%B0/VueDataProxy_k3joi8.png" alt="VueDataProxy" loading="lazy"></p>
<p>在 Vue 中，通过使用 <code>Object.defineProperty</code> 将 <code>data</code> 对象的属性添加到 <code>vm</code> 实例上，可以实现数据代理。这样在模板中就无需直接操作 <code>_data.属性</code>，而是可以通过 <code>vm</code> 对象来访问和修改属性。</p>
<h3 id="publishsubscribeinvue">Publish–Subscribe In Vue</h3>
<p>发布订阅模式和观察者模式的区别主要在于是否引入了事件总线作为通信的中介，以实现松耦合的通信方式。</p>
<p>Vue 中的 <code>Dep</code> 充当了中介者的角色。每个数据属性都有对应的 <code>Dep</code> 实例，它维护着依赖该属性的一组 <code>Watcher</code> 对象。当数据属性被读取时，<code>Watcher</code> 会将自身添加到该属性的 <code>Dep</code> 实例中，建立起依赖关系。当数据发生变化时，<code>Dep</code> 实例负责遍历其中的所有 <code>Watcher</code> 对象，并调用它们的更新方法，通知它们进行更新操作。</p>
<!--kg-card-end: markdown--><!--kg-card-begin: markdown--><h2 id="sourcecodeanalysis">Source Code Analysis</h2>
<p>本文中的源码分析参考于 Vue2.6.x（Vue2 的最后一个稳定版本），较试验性版本 Vue2.7.x 会具有更佳的稳定性与成熟度。</p>
<h3 id="dependencycollection">Dependency Collection</h3>
<p>Vue 通过 <code>initState</code> 初始化状态，该函数定义在源码 <code>src/core/instance/state.js</code> 中。</p>
<pre><code class="language-javascript">export function initState (vm: Component) {
  // 为组件实例添加一个空数组，用于存储后续创建的 Watcher 实例
  vm._watchers = []
  // 将组件实例的选项赋值给 opts 变量
  const opts = vm.$options
  if (opts.props) initProps(vm, opts.props)
  if (opts.methods) initMethods(vm, opts.methods)
  if (opts.data) {
    initData(vm)
  } else {
    // 组件没有 data 数据则创建一个空的观察对象并赋值给 vm._data，并将其标记为根数据
    observe(vm._data = {}, true /* asRootData */)
  }
  if (opts.computed) initComputed(vm, opts.computed)
  // 如果组件有 watch 监听器，且 watch 不等于 Vue 内置的原生 watch 实现，则调用 initWatch 函数对其进行初始化
  if (opts.watch &amp;&amp; opts.watch !== nativeWatch) {
    initWatch(vm, opts.watch)
  }
}
</code></pre>
<p>每个组件实例都有自己的观察者列表，存放该组件内用到的所有状态的依赖。当其中一个状态发生变化时，会通知到组件的观察者，然后组件内部使用虚拟 DOM 进行数据比对。</p>
<p>其中 <code>initProps</code> 和 <code>initData</code> 方法都调用了 <code>observe</code> 函数来将数据转化为响应式。<code>observe</code> 方法定义在 <code>src/core/observer/index.js</code> 中。当传入的值是一个非 <code>VNode</code> 的对象类型数据时，它会尝试为该值创建一个 <code>Observer</code> 实例，并将该值转化为响应式对象。</p>
<pre><code class="language-javascript">export function observe (value: any, asRootData: ?boolean): Observer | void {
  if (!isObject(value) || value instanceof VNode) {
    return
  }
  let ob: Observer | void
  // 如果该值已经被观察过（存在 ob 属性），则直接返回已存在的 Observer 实例
  if (hasOwn(value, '__ob__') &amp;&amp; value.__ob__ instanceof Observer) {
    ob = value.__ob__
  } else if (
    shouldObserve &amp;&amp;
    !isServerRendering() &amp;&amp;
    (Array.isArray(value) || isPlainObject(value)) &amp;&amp;
    Object.isExtensible(value) &amp;&amp;
    !value._isVue
  ) {
    ob = new Observer(value)
  }
  if (asRootData &amp;&amp; ob) {
    ob.vmCount++
  }
  return ob
}
</code></pre>
<p>在 <code>Observer</code> 类的构造函数中，首先会实例化一个 <code>Dep</code> 对象用于依赖管理。然后通过 <code>def</code> 函数将当前 <code>Observer</code> 实例添加到数据对象 <code>value</code> 的 <code>__ob__</code> 属性上。最后根据 <code>value</code> 进行处理。</p>
<pre><code class="language-javascript">export class Observer {
  value: any;
  dep: Dep; // 依赖管理器
  vmCount: number; // 作为根 $data 的组件实例数量
  constructor (value: any) {
    this.value = value
    this.dep = new Dep() // 创建依赖管理器
    this.vmCount = 0
    def(value, '__ob__', this) // 判断一个对象是否已经被观察过
    if (Array.isArray(value)) { // 在值为数组的情况下，要判断浏览器是否支持 __proto__ 属性
      if (hasProto) { // 通过修改原型链，可以让数组对象直接调用响应式数组的方法
        protoAugment(value, arrayMethods)
      } else { // 将响应式数组的方法拷贝到目标数组对象上
        copyAugment(value, arrayMethods, arrayKeys)
      }
      this.observeArray(value)
    } else {
      this.walk(value)
    }
  }
  // 遍历对象的所有属性，将其转化为 getter/setter
  walk (obj: Object) {
    const keys = Object.keys(obj)
    for (let i = 0; i &lt; keys.length; i++) {
      defineReactive(obj, keys[i])
    }
  }
  // 观察数组中的每个元素
  observeArray (items: Array&lt;any&gt;) {
    for (let i = 0, l = items.length; i &lt; l; i++) {
      observe(items[i])
    }
  }
}
</code></pre>
<p><code>Observer</code> 类中的 <code>Dep</code> 对象用于侦测整个对象的变化；<code>defineReactive</code> 函数中的新的 <code>Dep</code> 对象用于侦测单个属性的变化。这样可以实现对对象及其属性的精确依赖追踪和响应式操作。</p>
<pre><code class="language-javascript">export function defineReactive(
  obj: Object,
  key: string,
  val: any,
  customSetter?: ?Function,
  shallow?: boolean
) {
  // 创建一个依赖管理器
  const dep = new Dep();

  // 检查属性的描述符，如果属性不可配置，则返回
  const property = Object.getOwnPropertyDescriptor(obj, key);
  if (property &amp;&amp; property.configurable === false) {
    return;
  }

  // 处理预定义的 getter 和 setter
  const getter = property &amp;&amp; property.get;
  const setter = property &amp;&amp; property.set;
  if ((!getter || setter) &amp;&amp; arguments.length === 2) {
    // 如果没有 getter 或者有 setter，并且只有 2 个参数，则将 val 设置为 obj[key] 的值
    val = obj[key];
  }

  let childOb = !shallow &amp;&amp; observe(val);

  // 使用 Object.defineProperty 定义属性的 getter 和 setter
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter() {
      const value = getter ? getter.call(obj) : val;
      if (Dep.target) {
        // 收集依赖
        dep.depend();
        if (childOb) {
          childOb.dep.depend();
          if (Array.isArray(value)) {
            // 如果值是数组，则收集数组元素的依赖
            dependArray(value);
          }
        }
      }
      return value;
    },
    set: function reactiveSetter(newVal) {
      const value = getter ? getter.call(obj) : val;
      /* eslint-disable no-self-compare */
      if (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) {
        // 值没有发生变化时，不执行更新操作
        return;
      }
      
      ...
      
      // 如果有 setter，则调用 setter，否则直接更新 val 的值
      if (setter) {
        setter.call(obj, newVal);
      } else {
        val = newVal;
      }
      // 对新值进行观测
      childOb = !shallow &amp;&amp; observe(newVal);
      // 通知依赖进行更新
      dep.notify();
    },
  });
}
</code></pre>
<p>使用 <code>Object.defineProperty</code> 定义属性的 <code>getter</code> 和 <code>setter</code>。<code>getter</code> 是在读取属性时进行依赖收集，<code>setter</code> 是在属性变化时进行依赖通知和更新操作。需要注意的是，Vue2 的这种响应式系统设计仅能监听对象属性的读取和写，无法监听到属性的添加和删除。</p>
<ul>
<li>当属性的 <code>getter</code> 被访问时，<code>Dep.depend()</code> 方法会被调用，将当前的 <code>Dep</code> 实例添加到当前的订阅者 <code>Dep.target</code> 的依赖列表中，实现依赖的收集。</li>
<li>当属性的 <code>setter</code> 被调用时，<code>Dep.notify()</code> 方法会被调用，遍历 <code>subs</code> 数组，依次通知每个订阅者 watcher 属性的变化，触发更新操作。</li>
</ul>
<pre><code class="language-javascript">export default class Dep {
  static target: ?Watcher; // 用于存储当前正在计算的 Watcher 对象
  id: number; // Dep 的唯一标识
  subs: Array&lt;Watcher&gt;; // 订阅该 Dep 的所有 Watcher 对象数组

  constructor () {
    this.id = uid++ // 唯一标识自增
    this.subs = [] // 订阅该 Dep 的 Watcher 对象数组
  }

  addSub (sub: Watcher) {
    this.subs.push(sub) // 将 Watcher 对象添加到订阅列表中
  }

  removeSub (sub: Watcher) {
    remove(this.subs, sub) // 从订阅列表中移除指定的 Watcher 对象
  }

  depend () {
    if (Dep.target) {
      Dep.target.addDep(this) // 将当前 Dep 对象添加到当前计算的 Watcher 的依赖列表中
    }
  }

  notify () {
    // 先稳定订阅者列表的顺序
    const subs = this.subs.slice()
    if (process.env.NODE_ENV !== 'production' &amp;&amp; !config.async) {
      // 如果非异步更新且不处于生产环境
      // 则需要手动对订阅者列表进行排序，以确保它们按正确的顺序触发更新
      subs.sort((a, b) =&gt; a.id - b.id)
    }
    // 遍历订阅者列表，触发每个订阅者的更新操作
    for (let i = 0, l = subs.length; i &lt; l; i++) {
      subs[i].update()
    }
  }
}
</code></pre>
<p><code>Dep</code> 类位于 <code>src/core/observer/dep.js</code> 文件中。每个属性所对应的 <code>Dep</code> 实例都会具有唯一的标识，用于区分不同的依赖。<code>Dep</code> 实例的 <code>subs</code> 数组用于存储订阅该依赖的订阅者 watcher。</p>
<p>每个组件实例都对应各自的 <code>Watcher</code> 实例。<code>Watcher</code> 实例会在组件的 <code>beforeMount</code> 阶段创建。</p>
<p>每个 <code>Watcher</code> 实例都会订阅一个或多个依赖（<code>Dep</code> 实例）。当订阅的依赖发生变化时，<code>Dep</code> 实例会通知相应的 <code>Watcher</code> 实例执行更新操作。</p>
<pre><code class="language-javascript">export default class Watcher {
  constructor (
    vm: Component,
    expOrFn: string | Function,
    cb: Function,
    options?: ?Object,
    isRenderWatcher?: boolean
  ) {
    this.vm = vm // Vue 实例
    this.cb = cb // 回调函数
    // ...其他属性

    this.getter = parsePath(expOrFn) // 解析表达式或函数，生成一个读取数据的函数
    // ...其他初始化逻辑

    this.value = this.lazy
      ? undefined
      : this.get() // 初始化 value，若非 lazy，则执行 get() 方法获取初始值
  }

  get () {
    // 设置当前 Watcher 为 Dep.target，以便进行依赖收集
    pushTarget(this)
    let value
    const vm = this.vm
    // ...获取数据的逻辑
    // 收集完依赖后，恢复之前的 Dep.target
    popTarget()
    return value
  }

  update () {
    // ...更新逻辑
    // 调用 this.cb 回调函数，进行响应式更新
    this.cb.call(this.vm, value, oldValue)
  }
}
</code></pre>
<p><img src="https://res.cloudinary.com/dzb9ldnvl/image/upload/v1686852985/blog/zsghost/Vue%20%E6%9C%AD%E8%AE%B0/Vue_%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86_bhwvgg.png" alt="Vue2 响应式原理" loading="lazy"></p>
<p><code>Observer</code> 会把原始对象的每个属性通过 <code>Object.defineProperty</code> 数据劫持转换为带有 <code>getter</code> 和 <code>setter</code> 的属性（响应式对象）。当 <code>render</code> 函数在执行过程中访问到响应式数据时，会触发属性的 <code>getter</code> 方法。在 <code>getter</code> 方法中会通过 <code>dep.depend()</code> 来收集依赖，将当前的 <code>Dep</code> 对象添加到 <code>Watcher</code> 对象的依赖列表中。当响应式数据发生变化时，该数据所对应的 <code>setter</code> 方法就会被触发，执行 <code>dep.notify()</code> 通知与该数据相关的 <code>Dep</code> 对象。<code>Dep</code> 对象会遍历其中存储的所有 <code>Watcher</code> 对象，并调用每个 <code>Watcher</code> 对象的更新方法，即 <code>subs[i].update()</code>，此时会重新运行其对应的更新函数（通常是 render 函数）。</p>
<h3 id="diffvnode">Diff &amp; VNode</h3>
<p>在 Vue 中，虚拟 DOM 的实现是基于 <a href="https://github.com/snabbdom/snabbdom?ref=localhost">Snabbdom.js</a> 库。该库用于处理 DOM 的创建、更新和渲染。</p>
<pre><code class="language-shell">npm install -S snabbdom
npm install -D webpack webpack-cli webpack-dev-server
</code></pre>
<pre><code class="language-javascript">const path = require('path')
// const HtmlWebpackPlugin = require('html-webpack-plugin');
module.exports = {
  entry: './src/index.js',
  output: {
    publicPath: '/virtual',
    filename: 'bundle.js'
  },
  devServer: {
    port: 8080,
    contentBase: 'www' // 静态资源目录
  }
}
</code></pre>
<pre><code class="language-html">&lt;div id=&quot;container&quot;&gt;&lt;/div&gt;
&lt;script src=&quot;/virtual/bundle.js&quot;&gt;&lt;/script&gt;
</code></pre>
<pre><code class="language-javascript">console.log(&quot;bundle.js import completed&quot;);
import {
    init,
    classModule,
    propsModule,
    styleModule,
    eventListenersModule,
    h,
} from &quot;snabbdom&quot;;

const patch = init([
  // Init patch function with chosen modules
  classModule, // makes it easy to toggle classes
  propsModule, // for setting properties on DOM elements
  styleModule, // handles styling on elements with support for animations
  eventListenersModule, // attaches event listeners
]);

const container = document.getElementById(&quot;container&quot;);

const vnode = h(&quot;div#container.two.classes&quot;, { on: { click: function(){} } }, [
  h(&quot;span&quot;, { style: { fontWeight: &quot;bold&quot; } }, &quot;This is bold&quot;),
  &quot; and this is just normal text&quot;,
  h(&quot;a&quot;, { props: { href: &quot;/foo&quot; } }, &quot;I'll take you places!&quot;),
]);
// Patch into empty DOM element – this modifies the DOM as a side effect
patch(container, vnode);

const newVnode = h(
  &quot;div#container.two.classes&quot;,
  { on: { click: function(){} } },
  [
    h(
      &quot;span&quot;,
      { style: { fontWeight: &quot;normal&quot;, fontStyle: &quot;italic&quot; } },
      &quot;This is now italic type&quot;
    ),
    &quot; and this is still just normal text&quot;,
    h(&quot;a&quot;, { props: { href: &quot;/bar&quot; } }, &quot;I'll take you places!&quot;),
  ]
);
// Second `patch` invocation
patch(vnode, newVnode); // Snabbdom efficiently updates the old view to the new state
</code></pre>
<p>子节点更新策略：新前与旧前、新后与旧后、新后与旧前、新前与旧后。如果以上四种命中查找方式都未命中，就需要通过循环遍历旧节点列表来查找是否存在与当前新节点相同的节点，以确定是否需要移动或替换节点。</p>
<!--kg-card-end: markdown--><!--kg-card-begin: markdown--><h2 id="bug">BUG 分析</h2>
<ul>
<li><code>title</code>优化 ✔️</li>
</ul>
<p>针对不同打包环境展示不同内容，通过插件方式区别定义后报错如下:</p>
<pre><code>Template execution failed: ReferenceError: ❌... is not defined
ReferenceError: ❌... is not defined
  - index.html:7 eval
    [.]/[cli-service]/[html-webpack-plugin]/lib/loader.js!./public/index.html:7:
</code></pre>
<p><code>&lt;%= htmlWebpackPlugin.options.isProd ? '' : 'dev - ' %&gt;</code> 在注入模板字符串语法后，注释内容的不规范所导致。</p>
<ul>
<li>vue-ui新建项目 ✔️</li>
</ul>
<p>初始化项目时删除 <code>hello.vue</code> 后，在 <code>app.vue</code> 导入组件热编译运行报错:</p>
<pre><code>This relative module was not found:
* ../views/About.vue in ./src/router/index.js
</code></pre>
<p>项目中安装 router 依赖，需要及时更新 router 中对应的 index.js 相关初始化配置，指向 <code>app.vue</code>。</p>
<ul>
<li>warning ❓</li>
</ul>
<p>&quot;无法解析&quot; 的警告出现几率较为频繁，但是并不影响运行。<a href="https://github.com/vuejs/vue-cli/issues/2873?ref=localhost">详情移步</a></p>
<pre><code>WARN  
Couldn't parse bundle asset &quot;/Users/.../zsvuex/dist/js/chunk-vendors.js&quot;.
Analyzer will use module sizes from stats file.
</code></pre>
<ul>
<li>echarts ✔️</li>
</ul>
<p>使用 Echarts 可视化图表，在按照官方文档说明进行敲代码时，遇见如下<a href="https://github.com/PanJiaChen/vue-admin-template/issues/607?ref=localhost">报错</a>:</p>
<pre><code>[Echarts] TypeError: Cannot read property 'init' of undefined
</code></pre>
<p><code> var myChart = echarts.init(document.getElementById('main'));</code> 定位到存在  init 报错的位置。方法出现 undefined 考虑此调用对象的声明定义是否成功。补充代码 <code>var echarts = require('echarts');</code>。</p>
<ul>
<li>import ✔️</li>
</ul>
<p>引入 vant 组件库出现报错</p>
<pre><code>error  Import in body of module; reorder to top  import/first
</code></pre>
<p>代码格式规范要求所有的 <code>import</code> 在顶部，中间不允许出现其他代码，如<code>vue.use(vant)</code>。</p>
<ul>
<li>PostCSS Error ✔️</li>
</ul>
<p><code>npm install postcss-pxtorem -D</code> 下载将 px 转化为 rem 单位的插件出现报错:</p>
<pre><code>Syntax Error: Error: PostCSS plugin postcss-pxtorem requires PostCSS 8.
Migration guide for end-users:
https://github.com/postcss/postcss/wiki/PostCSS-8-for-end-users


 @ ./src/style/index.less ...
 @ ./src/main.js
 @ multi (webpack)-dev-server/client?http://192.xxx.xxx.2:8080&amp;sockPath=/sockjs-node (webpack)/hot/dev-server.js ./src/main.js
</code></pre>
<p>由于 postcss-pxtorem 版本过高，放弃了对旧 Node.js 版本的支持。考虑到 PostCSS 8 未带来重大的 API 更改。先执行: <code>npm uninstall postcss-pxtorem</code> 卸载当前版本。在 package.json 中 devDependencies 下添加&quot;postcss-pxtorem&quot;: &quot;^5.1.1&quot;，执行 <code>npm i</code> 安装制定版本包。</p>
<ul>
<li>ElementUI 按需加载后启动项目时的 babel-preset-es2015 报错。</li>
</ul>
<p>项目使用 @vue/cli 4.5.x 脚手架工具构建，根据<a href="https://element.eleme.cn/?ref=localhost#/zh-CN/component/quickstart">官方文档</a>中的提示按需引入。babelrc 和 babel.config.js 的区别在于，前者只会影响本项目中的代码，而后者会影响整个项目中的代码，包含 node_modules。</p>
<pre><code class="language-js">// 出错配置
module.exports = {
  &quot;presets&quot;: [
    '@vue/cli-plugin-babel/preset',[&quot;es2015&quot;, { &quot;modules&quot;: false }]
  ],
  &quot;plugins&quot;: [
    [
      &quot;component&quot;,
      {
        &quot;libraryName&quot;: &quot;element-ui&quot;,
        &quot;styleLibraryName&quot;: &quot;theme-chalk&quot;
      }
    ]
  ]
}
</code></pre>
<pre><code class="language-js">// Error
Cannot find module 'babel-preset-es2015'
</code></pre>
<p>修改 babel.config.js 文件，将 es2015 改为 @babel/preset-env。</p>
<pre><code class="language-js">// 正解配置
module.exports = {
  &quot;presets&quot;: [
    '@vue/cli-plugin-babel/preset',[&quot;@babel/preset-env&quot;, { &quot;modules&quot;: false }]
  ],
  &quot;plugins&quot;: [
    [
      &quot;component&quot;,
      {
        &quot;libraryName&quot;: &quot;element-ui&quot;,
        &quot;styleLibraryName&quot;: &quot;theme-chalk&quot;
      }
    ]
  ]
}
</code></pre>
<ul>
<li>引入字体</li>
</ul>
<p>将后缀名为 .ttf、.otf、.eot 等格式的字体包放入新建的 fonts 文件夹，并创建一个 fonts.css 文件用于定义所用字体。在 app.vue 中引入 fonts.css。</p>
<pre><code class="language-javascript">@font-face: {
  font-family: 'xxxyyy';
  /* 重命名字体名 */
  src: url('./xxxxxx.otf');
  font-weight: normal;
  font-style: normal;
}
</code></pre>
<pre><code class="language-javascript">&lt;style lang=&quot;scss&quot;&gt;
  @import './assets/fonts/fonts.css';
  #app {
    font-family: 'xxxyyy';
    font-weight: normal;
  }
&lt;/style&gt;
</code></pre>
<!--kg-card-end: markdown--><!--kg-card-begin: markdown--><h2 id>结束</h2>
<p>本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh?ref=localhost"> CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
<!--kg-card-end: markdown-->
    </section>

        <section class="article-comments gh-canvas">
        
        <script src="https://utteranc.es/client.js"
        repo="Zairesinatra/comments-by-utterances"
        issue-term="pathname"
        theme="photon-dark"
        crossorigin="anonymous"
        async>
        </script>
        
    </section>

</article>
</main>

    <section class="footer-cta outer">
        <div class="inner">
            <h2 class="footer-cta-title">Sign up for more like this.</h2>
            <a class="footer-cta-button" href="index.html#/portal" data-portal>
                <div class="footer-cta-input">Enter your email</div>
                <span>Subscribe</span>
            </a>
        </div>
    </section>



            <aside class="read-more-wrap outer">
                <div class="read-more inner">
                        
<article class="post-card post">

    <a class="post-card-image-link" href="../vim-neovim/index.html">

        <img class="post-card-image"
            srcset="../content/images/size/w600/2023/03/ScenicViewOfBeachDuringDaytime.jpg 600w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="../content/images/size/w600/2023/03/ScenicViewOfBeachDuringDaytime.jpg"
            alt="Scenic View Of Beach During Daytime"
            loading="lazy"
        />


    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../vim-neovim/index.html">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    Vim &amp; Neovim
                </h2>
            </header>
                <div class="post-card-excerpt">Vim ninjas count every keystroke!</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2022-12-12">Dec 12, 2022</time>
                <span class="post-card-meta-length">19 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post">

    <a class="post-card-image-link" href="../design-patterns/index.html">

        <img class="post-card-image"
            srcset="../content/images/size/w600/2023/03/SixHalogenBulbs.jpg 600w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="../content/images/size/w600/2023/03/SixHalogenBulbs.jpg"
            alt="Six Halogen Bulbs"
            loading="lazy"
        />


    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../design-patterns/index.html">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    Design Patterns And ...
                </h2>
            </header>
                <div class="post-card-excerpt">"A good programmer is someone who always looks both ways before crossing a one-way street." - Doug Linder</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2022-08-08">Aug 8, 2022</time>
                <span class="post-card-meta-length">35 min read</span>
        </footer>

    </div>

</article>
                        
<article class="post-card post">

    <a class="post-card-image-link" href="../g-toc-css/index.html">

        <img class="post-card-image"
            srcset="../content/images/size/w600/2023/03/GlassBottleFilledWithBlackStrawonBrownWoodenTable.jpg 600w"
            sizes="(max-width: 1000px) 400px, 800px"
            src="../content/images/size/w600/2023/03/GlassBottleFilledWithBlackStrawonBrownWoodenTable.jpg"
            alt="Glass Bottle Filled With Black Straw on Brown Wooden Table"
            loading="lazy"
        />


    </a>

    <div class="post-card-content">

        <a class="post-card-content-link" href="../g-toc-css/index.html">
            <header class="post-card-header">
                <div class="post-card-tags">
                </div>
                <h2 class="post-card-title">
                    G&amp;TOC&amp;CSS
                </h2>
            </header>
                <div class="post-card-excerpt">TOC 的需求实现以及相关的思考总结。</div>
        </a>

        <footer class="post-card-meta">
            <time class="post-card-meta-date" datetime="2022-05-01">May 1, 2022</time>
                <span class="post-card-meta-length">7 min read</span>
        </footer>

    </div>

</article>
                </div>
            </aside>



    </div>

    <div class="docsearchwrapper"><div id="docsearch"></div></div>
    <div class="arrowup">
      <svg
        version="1.1"
        id="Layer_1"
        xmlns="http://www.w3.org/2000/svg"
        xmlns:xlink="http://www.w3.org/1999/xlink"
        x="0px"
        y="0px"
        width="20px"
        height="20px"
        viewBox="0 0 122.883 122.882"
        enable-background="new 0 0 20 20"
        xml:space="preserve"
      >
        <g>
          <path
            d="M0,61.441L0,61.441h0.018c0,16.976,6.872,32.335,17.98,43.443c11.108,11.107,26.467,17.979,43.441,17.979v0.018h0.001 h0.001v-0.018c16.974,0,32.335-6.872,43.443-17.98s17.98-26.467,17.98-43.441h0.018v-0.001V61.44h-0.018 c0-16.975-6.873-32.334-17.98-43.443C93.775,6.89,78.418,0.018,61.443,0.018V0h-0.002l0,0v0.018 c-16.975,0-32.335,6.872-43.443,17.98C6.89,29.106,0.018,44.465,0.018,61.439H0V61.441L0,61.441z M42.48,71.7 c-1.962,1.908-5.101,1.865-7.009-0.098c-1.909-1.962-1.865-5.101,0.097-7.009l22.521-21.839l3.456,3.553l-3.46-3.569 c1.971-1.911,5.117-1.862,7.029,0.108c0.055,0.058,0.109,0.115,0.16,0.175L87.33,64.594c1.963,1.908,2.006,5.047,0.098,7.009 c-1.908,1.963-5.047,2.006-7.01,0.098L61.53,53.227L42.48,71.7L42.48,71.7z"
          />
        </g>
      </svg>
    </div>

    <footer class="site-footer outer">
        <div class="inner">
            <section class="copyright"><a href="../index.html">zairesinatra</a> &copy; 2023</section>
            <nav class="site-footer-nav">
                
            </nav>
            <div class="gh-powered-by"><a href="https://ghost.org/" target="_blank" rel="noopener">Powered by Ghost</a></div>
        </div>
    </footer>

</div>


<script
    src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
    crossorigin="anonymous">
</script>
<script src="../assets/built/casper.js%3Fv=3a5c6e94d3"></script>
<script>
$(document).ready(function () {
    // Mobile Menu Trigger
    $('.gh-burger').click(function () {
        $('body').toggleClass('gh-head-open');
    });
    // FitVids - Makes video embeds responsive
    $(".gh-content").fitVids();
});
</script>

<!-- searchinghost-easy -->
<!--
<script src="https://cdn.jsdelivr.net/gh/gmfmi/searchinghost-easy@latest/dist/searchinghost-easy-basic.js"></script>
<script>
    new SearchinGhostEasy({
        contentApiKey: 'e93d8b3520ae46be52c9a4b140'
    });
</script>
-->

<!-- Theme Mode -->
<script>
const switchTheme = function() {
  const storedTheme = localStorage.getItem("theme-color") || "theme-light";
  if (storedTheme === "theme-dark") {
    localStorage.setItem("theme-color", "theme-light");
    document.documentElement.classList.remove("dark-mode");
    document.querySelector(".theme-switcher")?.classList.remove("active");
    document.querySelector(".toc")?.classList.remove("active");
  } else {
    localStorage.setItem("theme-color", "theme-dark");
    document.documentElement.classList.add("dark-mode");
    document.querySelector(".theme-switcher")?.classList.add("active");
    document.querySelector(".toc")?.classList.add("active");
  }
};

const initTheme = function() {
  const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  const storedTheme = localStorage.getItem("theme-color");
  if (storedTheme) {
    if (storedTheme === "theme-dark") {
      document.querySelector(".theme-switcher")?.classList.add("active");
      document.querySelector(".toc")?.classList.add("active");
      document.documentElement.classList.add("dark-mode");
    }
  } else {
    if (prefersDarkMode) {
      localStorage.setItem("theme-color", "theme-dark");
      document.querySelector(".theme-switcher")?.classList.add("active");
      document.querySelector(".toc")?.classList.add("active");
      document.documentElement.classList.add("dark-mode");
    } else {
      localStorage.setItem("theme-color", "theme-light");
    }
  }
};

initTheme();
</script>

<script>
/* Arrow up */
// 通过位置判断是否显示
function onLoadHandle() {
  let viewportPositionTop =
    window.pageYOffset || document.documentElement.scrollTop;
  if (viewportPositionTop >= 200) {
    if (!$(".arrowup")) {
      arrowup.style.display = "inherit";
    } else {
      $(".arrowup").css("display", "inherit");
    }
  }
}
if (typeof jQuery === "undefined") {
  // Native JS
  let arrowup = document.querySelector(".arrowup");
  // 如果滚动距离达到一定值，显示按钮
  window.addEventListener("scroll", () => {
    arrowup.style.display = window.scrollY >= 200 ? "inherit" : "none";
  });
  // 在页面加载完成后执行的代码
  window.onload = function () {
    onLoadHandle();
  };
  // Back To The Top
  arrowup.addEventListener("click", function () {
    window.scrollTo({
      top: 0,
      behavior: "smooth"
    });
  });
} else {
  // jQuery
  $(window).scroll(function () {
    $(".arrowup").css("display", $(window).scrollTop() > 200 ? "inherit" : "none");
  });

  $(".arrowup").click(function () {
    $("html,body").animate({ scrollTop: 0 }, "slow");
  });

  $(document).ready(function () {
    onLoadHandle();
  });
}
</script>

<!-- Algolia DocSearch -->
<style>
.docsearchwrapper{
  display: none;
}
.DocSearch-Container{
  z-index: 9999999;
}
</style>

<!-- docsearch -->
<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>
<script>
function docSearchFuncMobile(){
    const DocSearchElement = document.querySelector(".DocSearch");
    DocSearchElement.click();
  }
</script>

<script type="text/javascript">
  docsearch({
    appId: "722DYFSYDR",
    apiKey: "5b7d4a36b43ac3d135ca6b83ac715f7e",
    indexName: "zairesinatraio",
    container: document.querySelector("#docsearch"),
    debug: false // Set debug to true if you want to inspect the modal
  });
</script>

<!-- 2023 => prismjs -->
<script src="https://cdn.jsdelivr.net/gh/Zairesinatra/GhostCDN@1.0.0/prism.js"></script>
<!-- Patch: additional supported languages -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-vim.min.js" integrity="sha512-P1MRK1H11qw68MAfAYVyjumLuurOQKO4wwcx4S2Nbbae9CndG92dkIXq34lsOeMFlWZoT7nVPgsOy3gepk93Bg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Activate Line Numbers in PrismJS -->
<script>
	window.addEventListener('DOMContentLoaded', (event) => {      
		document.querySelectorAll('pre[class*=language-]').forEach(function(node) {
			node.classList.add('line-numbers');
            node.style.border = 'solid #FFFFFF 1px'
		});
		Prism.highlightAll();
	});
</script>

<script>
/* Chrome Lighihouse Optimization */
window.addEventListener("DOMContentLoaded", (event) => {
  if (typeof jQuery === "undefined") {
    const searchBtnsForProps = document.querySelectorAll(".gh-search.gh-icon-btn");
    searchBtnsForProps.forEach((btn, i) => {
      btn.setAttribute("id", `GhostSearch${i}`);
      btn.setAttribute("aria-label", "Ghost Blog Search");
    });

    document.querySelector("button.gh-burger")
      .setAttribute("aria-label", "Ghost Blog Nav Menu");

    const siteLogo = document.querySelector(".site-logo");
    siteLogo.setAttribute("width", "120px");
    siteLogo.setAttribute("height", "120px");
  } else {
    $(".site-logo").attr({ width: "120px", height: "120px" });

    $(".gh-search.gh-icon-btn").each(function (index) {
      $(this).attr("id", `GhostSearch${index + 1}`);
      $(this).attr("aria-label", "Ghost Blog Search");
    });
  }
});
</script>

<!-- TOC -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.min.js"></script>
<script>
  tocbot.init({
    tocSelector: '.toc',
    contentSelector: '.gh-content',
    hasInnerContainers: true
  });
</script>
<script>
function tocHandle() {
  var tc = document.querySelector(".toc-container");
  var ah = document.querySelector(".article-header");
  
  if (tc && ah) {
    var tcch = tc.clientHeight;
    var ahch = ah.clientHeight;
    var isTocSticky = false;

    function handleScroll() {
      if (document.body.clientWidth > 1170) {
        var scrollY = window.pageYOffset || document.documentElement.scrollTop;
        var wih = window.innerHeight;

        if (scrollY >= wih + tcch + ahch && !isTocSticky) {
          tc.style.position = "sticky";
          tc.style.position = "-webkit-sticky";
          tc.style.top = "120px";
          tc.style.marginLeft = "800px";
          tc.style.minWidth = "260px";
          isTocSticky = true;
        }
        
        if (scrollY < tcch + ahch - 10 && isTocSticky) {
          tc.style.position = "";
          tc.style.top = "";
          tc.style.marginLeft = "";
          isTocSticky = false;
        }
      }
    }

    // 避免在每个滚动事件触发时都执行回调函数
    window.addEventListener("scroll", function () {
      requestAnimationFrame(handleScroll);
    });
  }
}

window.addEventListener("DOMContentLoaded", tocHandle);
</script>

</body>
</html>
