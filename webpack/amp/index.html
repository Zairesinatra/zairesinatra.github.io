<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <title>Webpack</title>

    <meta name="description" content="webpack 配置与异常" />
    <link rel="icon" href="../../content/images/size/w256h256/2021/07/ghost-orb.png" type="image/png" />
    <link rel="canonical" href="../index.html" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="zairesinatra" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Webpack" />
    <meta property="og:description" content="webpack 配置与异常" />
    <meta property="og:url" content="https://zairesinatra.github.io//webpack/" />
    <meta property="og:image" content="https://zairesinatra.github.io//content/images/2023/04/MickeyMouse.jpg" />
    <meta property="article:published_time" content="2021-03-08T11:55:00.000Z" />
    <meta property="article:modified_time" content="2023-04-07T15:58:15.000Z" />
    <meta property="article:tag" content="Bugs handled" />
    
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Webpack" />
    <meta name="twitter:description" content="webpack 配置与异常" />
    <meta name="twitter:url" content="https://zairesinatra.github.io//webpack/" />
    <meta name="twitter:image" content="https://zairesinatra.github.io//content/images/2023/04/MickeyMouse.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ziyi Xie" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Bugs handled" />
    <meta name="twitter:site" content="@xieziyi0422" />
    <meta property="og:image:width" content="1920" />
    <meta property="og:image:height" content="1080" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "zairesinatra",
        "url": "https://zairesinatra.github.io//",
        "logo": {
            "@type": "ImageObject",
            "url": "https://zairesinatra.github.io//content/images/2021/07/zs-1.JPG",
            "width": 60,
            "height": 60
        }
    },
    "author": {
        "@type": "Person",
        "name": "Ziyi Xie",
        "image": {
            "@type": "ImageObject",
            "url": "https://zairesinatra.github.io//content/images/2021/07/zs-2.JPG",
            "width": 1079,
            "height": 1079
        },
        "url": "https://zairesinatra.github.io//author/ziyi/",
        "sameAs": []
    },
    "headline": "Webpack",
    "url": "https://zairesinatra.github.io//webpack/",
    "datePublished": "2021-03-08T11:55:00.000Z",
    "dateModified": "2023-04-07T15:58:15.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://zairesinatra.github.io//content/images/2023/04/MickeyMouse.jpg",
        "width": 1920,
        "height": 1080
    },
    "keywords": "Bugs handled",
    "description": "webpack 配置与异常",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://zairesinatra.github.io//"
    }
}
    </script>

    <meta name="generator" content="Ghost 5.33" />
    <link rel="alternate" type="application/rss+xml" title="zairesinatra" href="../../rss/index.html" />

    <style amp-custom>
    *,
    *::before,
    *::after {
        box-sizing: border-box;
    }

    html {
        overflow-x: hidden;
        overflow-y: scroll;
        font-size: 62.5%;
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }

    body {
        min-height: 100vh;
        margin: 0;
        padding: 0;
        color: #3a4145;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.7rem;
        line-height: 1.55em;
        font-weight: 400;
        font-style: normal;
        background: #fff;
        scroll-behavior: smooth;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    p,
    ul,
    ol,
    li,
    dl,
    dd,
    hr,
    pre,
    form,
    table,
    video,
    figure,
    figcaption,
    blockquote {
        margin: 0;
        padding: 0;
    }

    ul[class],
    ol[class] {
        padding: 0;
        list-style: none;
    }

    img {
        display: block;
        max-width: 100%;
    }

    input,
    button,
    select,
    textarea {
        font: inherit;
        -webkit-appearance: none;
    }

    fieldset {
        margin: 0;
        padding: 0;
        border: 0;
    }

    label {
        display: block;
        font-size: 0.9em;
        font-weight: 700;
    }

    hr {
        position: relative;
        display: block;
        width: 100%;
        height: 1px;
        border: 0;
        border-top: 1px solid currentcolor;
        opacity: 0.1;
    }

    ::selection {
        text-shadow: none;
        background: #cbeafb;
    }

    mark {
        background-color: #fdffb6;
    }

    small {
        font-size: 80%;
    }

    sub,
    sup {
        position: relative;
        font-size: 75%;
        line-height: 0;
        vertical-align: baseline;
    }
    sup {
        top: -0.5em;
    }
    sub {
        bottom: -0.25em;
    }

    ul li + li {
        margin-top: 0.6em;
    }

    a {
        color: var(--ghost-accent-color, #1292EE);
        text-decoration-skip-ink: auto;
    }

    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        margin: 0;
        font-weight: 700;
        color: #121212;
        line-height: 1.4em;
    }

    h1 {
        font-size: 3.4rem;
        line-height: 1.1em;
    }

    h2 {
        font-size: 2.4rem;
        line-height: 1.2em;
    }

    h3 {
        font-size: 1.8rem;
    }

    h4 {
        font-size: 1.7rem;
    }

    h5 {
        font-size: 1.6rem;
    }

    h6 {
        font-size: 1.6rem;
    }

    amp-img {
        height: 100%;
        width: 100%;
        max-width: 100%;
        max-height: 100%;
    }

    amp-img img {
        object-fit: cover;
    }
    
    amp-youtube {
        height: calc(100vw / 1.78);
        width: 100vw;
        position: relative;
    }

    amp-youtube img {
        position: absolute;
    }

    .page-header {
        padding: 50px 5vmin 30px;
        text-align: center;
        font-size: 2rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .page-header a {
        color: #121212;
        font-weight: 700;
        text-decoration: none;
        font-size: 1.6rem;
        letter-spacing: -0.1px;
    }

    .post {
        max-width: 680px;
        margin: 0 auto;
    }

    .post-header {
        margin: 0 5vmin 5vmin;
        text-align: center;
    }

    .post-meta {
        margin: 1rem 0 0 0;
        text-transform: uppercase;
        color: #738a94;
        font-weight: 500;
        font-size: 1.3rem;
    }

    .post-image {
        margin: 0 0 5vmin;
    }

    .post-image img {
        display: block;
        width: 100%;
        height: auto;
    }

    .post-content {
        padding: 0 5vmin;
    }

    .post-content > * + * {
        margin-top: 1.5em;
    }

    .post-content [id]:not(:first-child) {
        margin: 2em 0 0;
    }

    .post-content > [id] + * {
        margin-top: 1rem;
    }

    .post-content [id] + .kg-card,
    .post-content blockquote + .kg-card {
        margin-top: 40px;
    }

    .post-content > ul,
    .post-content > ol,
    .post-content > dl {
        padding-left: 1.9em;
    }

    .post-content hr {
        margin-top: 40px;
    }

    .post .post-content hr + * {
        margin-top: 40px;
    }

    .post-content amp-img {
        background-color: #f8f8f8;
    }

    .post-content blockquote {
        position: relative;
        font-style: italic;
    }

    .post-content blockquote::before {
        content: "";
        position: absolute;
        left: -1.5em;
        top: 0;
        bottom: 0;
        width: 0.3rem;
        background: var(--ghost-accent-color, #1292EE);
    }

    .post-content blockquote.kg-blockquote-alt {
        font-size: 1.2em;
        font-style: italic;
        line-height: 1.6em;
        text-align: center;
        color: #738a94;
        padding: 0.75em 3em 1.25em;
    }

    .post-content blockquote.kg-blockquote-alt::before {
        display: none;
    }

    .post-content :not(.kg-card):not([id]) + .kg-card {
        margin-top: 40px;
    }

    .post-content .kg-card + :not(.kg-card) {
        margin-top: 40px;
    }

    .kg-card figcaption {
        padding: 1.5rem 1.5rem 0;
        text-align: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.4em;
        opacity: 0.6;
    }

    .kg-card figcaption strong {
        color: rgba(0,0,0,0.8);
    }

    .post-content :not(pre) code {
        vertical-align: middle;
        padding: 0.15em 0.4em 0.15em;
        border: #e1eaef 1px solid;
        font-weight: 400;
        font-size: 0.9em;
        line-height: 1em;
        color: #15171a;
        background: #f0f6f9;
        border-radius: 0.25em;
    }

    .post-content > pre {
        overflow: scroll;
        padding: 16px 20px;
        color: #fff;
        background: #1F2428;
        border-radius: 5px;
        box-shadow: 0 2px 6px -2px rgba(0,0,0,.1), 0 0 1px rgba(0,0,0,.4);
    }

    .kg-embed-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    .kg-image-card img {
        margin: auto;
    }

    .kg-gallery-card + .kg-gallery-card {
        margin-top: 0.75em;
    }

    .kg-gallery-container {
        position: relative;
    }

    .kg-gallery-row {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .kg-gallery-image {
        width: 100%;
        height: 100%;
    }

    .kg-gallery-row:not(:first-of-type) {
        margin: 0.75em 0 0 0;
    }

    .kg-gallery-image:not(:first-of-type) {
        margin: 0 0 0 0.75em;
    }

    .kg-bookmark-card,
    .kg-bookmark-publisher {
        position: relative;
    }

    .kg-bookmark-container,
    .kg-bookmark-container:hover {
        display: flex;
        flex-wrap: wrap;
        flex-direction: row-reverse;
        color: currentColor;
        background: rgba(255,255,255,0.6);
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        text-decoration: none;
        border-radius: 3px;
        box-shadow: 0 2px 6px -2px rgba(0, 0, 0, 0.1), 0 0 1px rgba(0, 0, 0, 0.4);
        overflow: hidden;
    }

    .kg-bookmark-content {
        flex-basis: 0;
        flex-grow: 999;
        padding: 20px;
        order: 1;
    }

    .kg-bookmark-title {
        font-weight: 600;
        font-size: 1.5rem;
        line-height: 1.3em;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        max-height: 45px;
        margin: 0.5em 0 0 0;
        font-size: 1.4rem;
        line-height: 1.55em;
        overflow: hidden;
        opacity: 0.8;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
    }

    .kg-bookmark-metadata {
        margin-top: 20px;
    }

    .kg-bookmark-metadata {
        display: flex;
        align-items: center;
        font-weight: 500;
        font-size: 1.3rem;
        line-height: 1.3em;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .kg-bookmark-description {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
    }

    .kg-bookmark-metadata amp-img {
        width: 18px;
        height: 18px;
        max-width: 18px;
        max-height: 18px;
        margin-right: 10px;
    }

    .kg-bookmark-thumbnail {
        display: flex;
        flex-basis: 20rem;
        flex-grow: 1;
        justify-content: flex-end;
    }

    .kg-bookmark-thumbnail amp-img {
        max-height: 200px;
    }

    .kg-bookmark-author {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
    }

    .kg-bookmark-publisher::before {
        content: "•";
        margin: 0 .5em;
    }

    .kg-toggle-card-icon {
        display: none;
    }

    .kg-toggle-content {
        margin-top: 0.8rem;
    }

    .kg-product-card-container {
        background: transparent;
        padding: 20px;
        width: 100%;
        border-radius: 5px;
        box-shadow: inset 0 0 0 1px rgb(124 139 154 / 25%);
    }

    .kg-product-card-description p {
        margin-top: 1.5em;
    }

    .kg-product-card-description ul {
        margin-left: 24px;
    }

    .kg-product-card-title {
        font-size: 1.9rem;
        font-weight: 700;
    }

    .kg-product-card-rating-star {
        height: 28px;
        width: 20px;
        margin-right: 2px;
    }

    .kg-product-card-rating-star svg {
    width: 16px;
    height: 16px;
    fill: currentColor;
    opacity: 0.15;
    }

    .kg-product-card-rating-active.kg-product-card-rating-star svg {
    opacity: 1;
    }

    .kg-nft-card-container {
        position: relative;
        display: flex;
        flex: auto;
        flex-direction: column;
        text-decoration: none;
        font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;
        font-size: 1.4rem;
        font-weight: 400;
        box-shadow: 0 2px 6px -2px rgb(0 0 0 / 10%), 0 0 1px rgb(0 0 0 / 40%);
        width: 100%;
        max-width: 512px;
        color: #15212A;
        background: #fff;
        border-radius: 5px;
        transition: none;
        margin: 0 auto;
    }

    .kg-nft-metadata {
        padding: 2.0rem;
    }

    .kg-nft-image-container {
        position: relative;
    }

    .kg-nft-image {
        display: flex;
        border-radius: 5px 5px 0 0;
    }

    .kg-nft-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 20px;
    }

    .kg-nft-header h4.kg-nft-title {
        font-size: 1.9rem;
        font-weight: 700;
        margin: 0;
        color: #15212A;
    }

    .kg-nft-header amp-img {
        max-width: 114px;
        max-height: 26px;
    }

    .kg-nft-opensea-logo {
        margin-top: 2px;
        width: 100px;
    }

    .kg-nft-creator {
        font-family: inherit;
        color: #95A1AD;
    }

    .kg-nft-creator span {
        font-weight: 500;
        color: #15212A;
    }

    .kg-nft-card p.kg-nft-description {
        font-size: 1.4rem;
        line-height: 1.4em;
        margin: 2.0rem 0 0;
        color: #222;
    }

    .kg-button-card {
        display: flex;
        position: static;
        align-items: center;
        width: 100%;
        justify-content: center;
    }

    .kg-btn {
        display: flex;
        position: static;
        align-items: center;
        padding: 0 2.0rem;
        height: 4.0rem;
        line-height: 4.0rem;
        font-size: 1.65rem;
        font-weight: 600;
        text-decoration: none;
        border-radius: 5px;
        transition: opacity 0.2s ease-in-out;
    }

    .kg-btn:hover {
        opacity: 0.85;
    }

    .kg-btn-accent {
        background-color: var(--ghost-accent-color, #1292EE);
        color: #fff;
    }

    .kg-callout-card {
        display: flex;
        padding: 20px 28px;
        border-radius: 3px;
    }

    .kg-callout-card-grey {
        background: rgba(124, 139, 154, 0.13);
    }

    .kg-callout-card-white {
        background: transparent;
        box-shadow: inset 0 0 0 1px rgba(124, 139, 154, 0.25);
    }

    .kg-callout-card-blue {
        background: rgba(33, 172, 232, 0.12);
    }

    .kg-callout-card-green {
        background: rgba(52, 183, 67, 0.12);
    }

    .kg-callout-card-yellow {
        background: rgba(240, 165, 15, 0.13);
    }

    .kg-callout-card-red {
        background: rgba(209, 46, 46, 0.11);
    }

    .kg-callout-card-pink {
        background: rgba(225, 71, 174, 0.11);
    }

    .kg-callout-card-purple {
        background: rgba(135, 85, 236, 0.12);
    }

    .kg-callout-card-accent {
        background: var(--ghost-accent-color);
        color: #fff;
    }

    .kg-callout-card-accent a {
        color: #fff;
    }

    .kg-callout-emoji {
        padding-right: 16px;
        line-height: 1.3;
        font-size: 1.25em;
    }

    .kg-header-card {
        padding: 6em 3em;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    .kg-header-card.kg-size-small {
        padding-top: 4em;
        padding-bottom: 4em;
    }

    .kg-header-card.kg-size-large {
        padding-top: 12em;
        padding-bottom: 12em;
    }

    .kg-header-card.kg-width-full {
        padding-left: 4em;
        padding-right: 4em;
    }

    .kg-header-card.kg-align-left {
        text-align: left;
        align-items: flex-start;
    }

    .kg-header-card.kg-style-dark {
        background: #15171a;
        color: #ffffff;
    }

    .kg-header-card.kg-style-light {
        color: #15171a;
        border: 1px solid rgba(124, 139, 154, 0.25);
        border-width: 1px 0;
    }

    .kg-header-card.kg-style-accent {
        background-color: var(--ghost-accent-color);
    }

    .kg-header-card.kg-style-image {
        background-color: #e7e7eb;
        background-size: cover;
        background-position: center center;
    }

    .kg-header-card h2 {
        font-size: 4em;
        font-weight: 700;
        line-height: 1.1em;
        margin: 0;
    }

    .kg-header-card h2 strong {
        font-weight: 800;
    }

    .kg-header-card.kg-size-small h2 {
        font-size: 3em;
    }

    .kg-header-card.kg-size-large h2 {
        font-size: 5em;
    }

    .kg-header-card h3 {
        font-size: 1.25em;
        font-weight: 500;
        line-height: 1.3em;
        margin: 0;
    }

    .kg-header-card h3 strong {
        font-weight: 600;
    }

    .kg-header-card.kg-size-small h3 {
        font-size: 1em;
    }

    .kg-header-card.kg-size-large h3 {
        font-size: 1.5em;
    }

    .kg-header-card:not(.kg-style-light) h2,
    .kg-header-card:not(.kg-style-light) h3 {
        color: #ffffff;
    }

    .kg-header-card a.kg-header-card-button {
        display: flex;
        position: static;
        align-items: center;
        padding: 0 1.2em;
        height: 2.4em;
        line-height: 1em;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-size: 0.95em;
        font-weight: 600;
        text-decoration: none;
        border-radius: 5px;
        transition: opacity 0.2s ease-in-out;
        background-color: var(--ghost-accent-color);
        color: #ffffff;
        margin: 1.75em 0 0;
    }

    .kg-header-card a.kg-header-card-button:hover {
        opacity: 0.85;
    }

    .kg-header-card.kg-size-large a.kg-header-card-button {
        margin-top: 2em;
    }

    .kg-header-card.kg-size-small a.kg-header-card-button {
        margin-top: 1.5em;
    }

    .kg-header-card.kg-style-image a.kg-header-card-button,
    .kg-header-card.kg-style-dark a.kg-header-card-button {
        background: #ffffff;
        color: #15171a;
    }

    .kg-header-card.kg-style-accent a.kg-header-card-button {
        background: #ffffff;
        color: var(--ghost-accent-color);
    }

    .kg-audio-card {
        display: flex;
        width: 100%;
        box-shadow: inset 0 0 0 1px rgba(124, 139, 154, 0.25);
    }

    .kg-audio-thumbnail {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 80px;
        min-width: 80px;
        height: 80px;
        background: transparent;
        object-fit: cover;
        aspect-ratio: 1/1;
        border-radius: 3px 0 0 3px;
    }

    .kg-audio-thumbnail.placeholder {
        background: var(--ghost-accent-color);
    }

    .kg-audio-thumbnail.placeholder svg {
        width: 24px;
        height: 24px;
        fill: white;
    }

    .kg-audio-player-container {
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        width: 100%;
        --seek-before-width: 0%;
        --volume-before-width: 100%;
        --buffered-width: 0%;
    }

    .kg-audio-title {
        width: 100%;
        padding: 8px 12px 0;
        border: none;
        font-family: inherit;
        font-size: 1.1em;
        font-weight: 700;
        background: transparent;
    }

    .kg-audio-player {
        display: none;
    }

    .kg-width-full.kg-card-hascaption {
        display: grid;
        grid-template-columns: inherit;
    }

    .post-content table {
        border-collapse: collapse;
        width: 100%;
    }

    .post-content th {
        padding: 0.5em 0.8em;
        text-align: left;
        font-size: .75em;
        text-transform: uppercase;
    }

    .post-content td {
        padding: 0.4em 0.7em;
    }

    .post-content tbody tr:nth-child(2n + 1) {
        background-color: rgba(0,0,0,0.1);
        padding: 1px;
    }

    .post-content tbody tr:nth-child(2n + 2) td:last-child {
        box-shadow:
            inset 1px 0 rgba(0,0,0,0.1),
            inset -1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:nth-child(2n + 2) td {
        box-shadow: inset 1px 0 rgba(0,0,0,0.1);
    }

    .post-content tbody tr:last-child {
        border-bottom: 1px solid rgba(0,0,0,.1);
    }

    .page-footer {
        padding: 60px 5vmin;
        margin: 60px auto 0;
        text-align: center;
        background-color: #f8f8f8;
    }

    .page-footer h3 {
        margin: 0.5rem 0 0 0;
    }

    .page-footer p {
        max-width: 500px;
        margin: 1rem auto 1.5rem;
        font-size: 1.7rem;
        line-height: 1.5em;
        color: rgba(0,0,0,0.6)
    }

    .powered {
        display: inline-flex;
        align-items: center;
        margin: 30px 0 0;
        padding: 6px 9px 6px 6px;
        border: rgba(0,0,0,0.1) 1px solid;
        font-size: 12px;
        line-height: 12px;
        letter-spacing: -0.2px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
        font-weight: 500;
        color: #222;
        text-decoration: none;
        background: #fff;
        border-radius: 6px;
    }

    .powered svg {
        height: 16px;
        width: 16px;
        margin: 0 6px 0 0;
    }

    @media (max-width: 600px) {
        body {
            font-size: 1.6rem;
        }
        h1 {
            font-size: 3rem;
        }

        h2 {
            font-size: 2.2rem;
        }
    }

    @media (max-width: 400px) {
        h1 {
            font-size: 2.6rem;
            line-height: 1.15em;
        }
        h2 {
            font-size: 2rem;
            line-height: 1.2em;
        }
        h3 {
            font-size: 1.7rem;
        }
    }

    :root {--ghost-accent-color: #15171A;}
    </style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="page-header">
        <a href="../../index.html">
                <amp-img class="site-icon" src="https://zairesinatra.github.io//content/images/2021/07/ghost-orb.png" width="50" height="50" layout="fixed" alt="zairesinatra"></amp-img>
        </a>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">Webpack</h1>
                <section class="post-meta">
                    Ziyi Xie -
                    <time class="post-date" datetime="2021-03-08">08 Mar 2021</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://zairesinatra.github.io//content/images/2023/04/MickeyMouse.jpg" width="600" height="340" layout="responsive" 
                alt="Mickey Mouse"
                ></amp-img>
            </figure>
            <section class="post-content">

                <h2 id="gettingstarted">Getting Started</h2>
<h3 id="introtowebpack">Intro to Webpack</h3>
<blockquote>
<p>Webpack takes modules with dependencies and generates static assets representing those modules.</p>
</blockquote>
<p>webpack-cli 是一个与 webpack 相关的命令行工具，用于在终端中执行指定命令，解析命令行参数，并把这些参数传递给 webpack。</p>
<p>注意，webpack 本身并没有内置命令行工具，如果没有安装 webpack-cli，直接在终端里执行 webpack 命令时会报错。</p>
<pre><code class="language-shell">$ npx webpack --entry ./src/main.js --output-path ./build --mode=development
</code></pre>
<p><code>npx</code> 可理解为使用本地的模块，实际上是运行当前项目中 <code>node_modules/.bin</code> 下的可执行文件。</p>
<p><code>package.json</code> 文件的 <code>scripts</code> 字段不需要在命令的前面加上 <code>npx</code>。与 <code>webpack.config.js</code> 一样，<code>package.json</code> 中的 <code>scripts</code> 字段可以直接使用本地安装的模块或全局安装的命令。</p>
<pre><code class="language-json">{
  "scripts": {
    "build": "webpack --entry ./src/main.js --output-path ./build --mode=development"
  }
}
</code></pre>
<p><code>npm run</code> 会在当前目录下新建一个 Shell，并将当前目录下的 <code>node_modules/.bin</code> 加入 <code>PATH</code> 变量，使得在执行脚本命令时可以直接引用该目录下的可执行文件。在执行结束以后，路径变量会恢复原样，以保证环境变量的稳定性。这就是 <code>npm run</code> 能够执行项目本地安装的 CLI 工具的原因。</p>
<p>除上述方法外，项目中更多见的是使用 <code>webpack.config.js</code> 之流的配置文件进行打包的相关设置。</p>
<pre><code class="language-javascript">const { resolve } = require("path");
module.exports = { 
  entry: "./src/main.js", // 入口文件可以是相对路径
  output: {
  	filename: "bundle.js",
  	path: resolve(__dirname, "./build") // 输出文件路径必须是绝对路径
  },
  mode: "development"
};
</code></pre>
<pre><code class="language-shell">$ npx webpack --config webpack.config.js
</code></pre>
<pre><code class="language-json">"scripts": {
  "build": "webpack --config webpack.config.js"
}
</code></pre>
<p>webpack 通常使用 CommonJS 模块化规范来读取配置文件，即配置文件中通过 <code>module.exports</code> 导出一个对象，对象中包含了各种打包配置信息。注意，配置文件须放在项目根目录下。</p>
<p>通过读取项目里的配置文件，解析代码中模块引用关系，可将这些模块打包成一个或多个 JS bundle 文件。这些 bundle 文件包含了应用中的所有代码、样式、图片等资源。</p>
<p>通过将这些资源打包成 bundle，可以减少浏览器加载资源的请求次数，提高页面性能和加载速度：</p>
<ul>
<li>在 HTTP/1.1 协议下，打包文件可以减少客户端发起请求的次数，降低 TCP 连接的占用</li>
<li>在 HTTP/2 协议下，代码分割可以将应用代码拆分成多个小块，进一步提升页面加载速度</li>
</ul>
<blockquote>
<p>HTTP/1.1 协议规定，在客户端发起请求时会建立一个 TCP 连接，在该连接上进行请求和响应。在此期间，不管请求的文件大小是多少，都会占用该连接，直到响应完成才会释放连接。</p>
</blockquote>
<blockquote>
<p>HTTP/2 协议支持多路复用，即一个 TCP 连接可以同时发送多个请求和响应。因此，使用 HTTP/2 协议时，每个文件的请求和响应都可以独立完成，不会相互影响。同时，HTTP/2 还支持服务器推送，即在客户端请求一个资源时，服务器可以主动推送与该资源相关的其他资源。</p>
</blockquote>
<p>在打包时默认会将所有直接或间接被引入到入口文件中的模块都打包，包括那些被引用的但实际上并未被使用的模块。摇树优化可以通过静态代码分析，识别出哪些模块中的代码是无用的，并将其从打包结果中移除，从而减小打包文件的体积。</p>
<p>总的来说，Webpack 是一种静态打包工具，通过在本地将所有代码和资源打包到一个或多个 bundle 之中，并且可以在构建过程中对代码进行一系列的优化，如代码压缩、摇树优化、代码分割等，最终生成优化后的打包文件。Webpack 缺点是构建速度较慢，尤其是在大型项目中，构建时间的可能会很长。</p>
<blockquote>
<p>Vite is built on top of Snowpack, a lightweight alternative to Webpack. Vite leverages the native ES module support in modern browsers, employs an on-demand compilation packaging approach, and dynamically compiles code at runtime without the need to pre-bundle all content. This enables Vite to start up and rebuild applications more quickly.</p>
</blockquote>
<p>应用程序启动和重新加载过程中常见的名词解释：</p>
<ul>
<li>热重载或热更新：程序运行时，无需停止或重启应用即可动态更新代码或资源文件</li>
<li>冷启动：在应用的首次启动时，需要重新加载所有必要的资源和配置文件</li>
<li>热启动：在应用已经启动并运行时，再次启动该应用程序（应用的许多资源已在内存中加载）</li>
<li>温启动：在应用已经启动并运行时，重新加载已经被关闭或过期的组件</li>
</ul>
<h3 id="basicloaders">Basic Loaders</h3>
<p>Loaders 用于对模块的源代码进行转换，将一种形式的源代码转换为另一种形式的源代码，以此满足特定的需求。</p>
<pre><code class="language-shell"># 因缺乏相应 loader 而导致的解析失败
Module parse failed: Unexpected token. You may need an appropriate loader to handle this file type.
</code></pre>
<p>配置文件中 <code>module.rules</code> 字段对应的值是数组 <code>[Rule]</code>。数组中存放一个或多个 Rule 对象，Rule 对象中具有 <code>test</code> 和 <code>use</code> 属性。</p>
<ul>
<li><code>test</code> 字段用于对资源进行匹配，通常设置成正则表达式</li>
<li><code>use</code> 字段值是一个 <code>[UseEntry]</code> 数组，其中 <code>UseEntry</code> 对象又具有以下属性
<ul>
<li><code>loader</code> 必选属性，对应的值是一个字符串</li>
<li><code>options</code> 可选属性，值是字符串或者对象，通常会传入到 loader 中</li>
</ul>
</li>
</ul>
<p>基础样式资源的打包通常需要 <a href="https://webpack.js.org/loaders/css-loader/">css-loader</a> 和 <a href="https://webpack.js.org/loaders/style-loader/">style-loader</a>。</p>
<ul>
<li>css-loader 处理 <code>@import</code> 和 <code>url()</code>，将 CSS 文件解析成样式字符串的 CJS 模块加载至 JS</li>
<li>style-loader 创建 <code>style</code> 标签并将 JS 里的样式添加到 <code>head</code> 元素（插入 DOM 树）</li>
</ul>
<pre><code class="language-shell">$ npm i css-loader style-loader less-loader less -D
</code></pre>
<p>通常 <code>use</code> 属性的值是一个字符串数组，这是使用了 <code>loader</code> 属性的简写方式。也有将 <code>use</code> 属性省略掉的时候，直接写上 <code>loader</code> 属性，但这只适用于一个 loader 的情况。</p>
<pre><code class="language-javascript">module: { // 不同文件必须配置不同 loader 处理
  rules: [
    {
      test: /\.css$/,
      use: [ 'style-loader', 'css-loader' ] // 语法糖
    },
    { 
      test: /\.less$/, 
      use: [ 'style-loader', 'css-loader', 'less-loader' ] // less-loader 将 less 文件编译成 css 
    } 
  ] 
}
</code></pre>
<p>在 Concepts 下 Loaders 中除 Configuration 外，还有一种 <a href="https://webpack.js.org/concepts/loaders/#inline">Inline</a> 内联的方式使用 loaders。多个 loader 的执行顺序是从后往前的。</p>
<p><a href="https://github.com/browserslist/browserslist">browserslist</a> 是一款用于配置项目中目标浏览器的工具，可以在不同的工具之间共享信息。</p>
<blockquote>
<p>browserslist is used in: Autoprefixer, Babel, postcss-preset-env, eslint-plugin-compat, stylelint-no-unsupported-browser-features, postcss-normalize, obsolete-webpack-plugin...</p>
</blockquote>
<p>通过 browserslist 指定一系列的浏览器及其版本，可以通知其他工具应该如何生成代码，以适配指定的目标浏览器（自动添加 CSS 前缀、使用相应的 Polyfill、转换 ES6+ 语法等）。</p>
<pre><code class="language-shell">$ npx browserslist "&gt;1%, last 2 version, not dead"
</code></pre>
<p>browserslist 的配置可以写在项目根目录下的 <code>.browserslistrc</code> 中，也可以写在 <code>package.json</code> 文件中的 <code>browserslist</code> 字段，支持的浏览器版本可以使用通配符以及范围来配置。</p>
<pre><code class="language-javascript">// package.json
"browserslist": { 
  "development": [ 
    // 兼容最近的浏览器版本
    "last 1 chrome version", 
    "last 1 firefox version",
    "last 1 safari version" 
  ],
  "production": [ 
    "&gt;0.2%",
    "not dead",
    "not op_mini all" 
  ]
}
</code></pre>
<p>通常情况下，在使用 Webpack 进行项目开发时，会默认安装 browserslist 这个库，因为很多 Webpack 插件和 loader 都会使用 browserslist 来进行浏览器兼容性检查和自动添加前缀等操作。而 browserslist 内部使用了 caniuse-lite 数据库来进行浏览器的兼容性查询。</p>
<p>PostCSS 是一个用 JavaScript 实现的 CSS 处理器，通过解析 CSS 并以抽象语法树 AST 的形式存储，从而可以在 AST 层面上对 CSS 进行操作，例如添加前缀、处理嵌套、转换 CSS 语法等。如果需要单独在命令行中使用，应该额外再安装一个 postcss-cli 工具。</p>
<p>同时有很多优秀的插件也是基于 PostCSS 诞生的，如 PreCSS、CSSNext、cssnano、Autoprefixer 等。</p>
<pre><code class="language-js">{
  test: /\.css$/,
  use: [
    "style-loader",
    "css-loader",
    {
      loader: "postcss-loader",
      options: {
        postcssOptions: {
          plugins: [
            require("autoprefixer")
          ]
        }
      }
    }
  ]
}
</code></pre>
<p>事实上，在配置 postcss-loader 时，更多的会使用 postcss-preset-env。postcss-preset-env 将一些现代 CSS 特性转换为大多数浏览器都能理解的 CSS，并自动添加所需的 polyfill。此外，postcss-preset-env 还自动集成了 Autoprefixer 插件，因此不需要单独配置 Autoprefixer。</p>
<pre><code class="language-js">{
  test: /\.css$/,
  use: [
    "style-loader",
    "css-loader",
    {
      loader: "postcss-loader",
      options: {
        postcssOptions: {
          plugins: [
            require("postcss-preset-env")
          ]
        }
      }
    }
  ]
}
</code></pre>
<p>此外，也完全可以将 postcss-loader 的配置移到 <code>postcss.config.js</code> 文件中，代码如下。</p>
<pre><code class="language-javascript">// postcss.config.js
module.exports = {
  plugins: [
    require("postcss-preset-env")
  ]
}
</code></pre>
<pre><code class="language-javascript">use: [ "style-loader", "css-loader", "postcss-loader" ]
</code></pre>
<p>如果有在 CSS 文件中通过 <code>@import</code> 导入其他的 CSS 文件，那么这些导入的 CSS 可能不会被 postcss-loader 或者 less-loader 等处理，因为 Webpack 只会对直接引入的 CSS 文件应用 loaders，而不会递归地处理引入的 CSS 文件。</p>
<p>此时可以在使用 css-loader 时配置 <code>importLoaders</code> 选项。<code>importLoaders</code> 选项控制在处理 CSS 文件时，css-loader 应该使用几个额外的 loader 来处理 <code>@import</code> 引入的其他 CSS 文件。例如，在 css-loader 中设置 <code>importLoaders: 1</code>，那么在处理 CSS 文件时，css-loader 将同时使用 postcss-loader 来处理 <code>@import</code> 导入的 CSS 文件。</p>
<pre><code class="language-js">{
  test: /\.css$/,
  use: [
    'style-loader',
    {
      loader: 'css-loader',
      options: {
        importLoaders: 1 // 这里设置为 1
      }
    },
    'postcss-loader'
  ]
}
</code></pre>
<pre><code class="language-js">{
  test: /\.less$/,
  use: [
    'style-loader',
    {
      loader: 'css-loader',
      options: {
        importLoaders: 2 // 这里设置为 2
      }
    },
    'postcss-loader',
    'less-loader'
  ]
}

</code></pre>
<p>使用图片时，常见的两种方式是 <code>img</code> 元素的 <code>src</code> 属性和 CSS 中的 <code>background-image</code> 属性。</p>
<blockquote>
<p>The file-loader resolves <code>import/require()</code> on a file into a url and emits the file into the output dir.</p>
</blockquote>
<blockquote>
<p>The url-loader works like file-loader, but can return a DataURL if a file is smaller than a byte limit.</p>
</blockquote>
<p>file-loader 会根据文件的内容使用 MD4 算法生成文件名。但是在某些情况下，可能需要使用占位符来自定义生成的文件名，以确保每张图片都有一个明确的对应关系。此时应考虑 <a href="https://v4.webpack.js.org/loaders/file-loader/#placeholders">placeholders</a>。</p>
<pre><code class="language-js">{
  test: /\.(png|jpg|gif)$/i,
  loader: 'file-loader',
  options: {
    name: '[name]-[hash].[ext]',
    outputPath: 'images/'
  }
}
</code></pre>
<p>开发中，较大的图片文件往往会被存放在单独的目录，通过异步加载的方式来减少页面的加载时间。较小的图片通常会使用 Base64 数据直接嵌入到 HTML 或 CSS 文件，而不作为单独的文件加载。</p>
<p>url-loader 可以将指定大小以下的图片文件转换成 Base64 数据，直接嵌入到生成的 bundle.js 中，从而减少了额外的网络请求，提高页面的性能和加载速度。</p>
<pre><code class="language-js">{
  test: /\.(png|jpe?g|gif)$/i,
  use: [
    {
      loader: 'url-loader',
      options: {
        limit: 100 * 1024, // 100KB
        name: 'images/[name]-[hash:6].[ext]'
      }
    }
  ]
}
</code></pre>
<p>url-loader 默认使用 ESM，而 html-loader 默认使用 CommonJS。如果在使用 url-loader 时，解析出现了 <code>[object Module]</code> 的问题，可能是由于 url-loader 默认使用了 ESM 模块系统，而配置文件中存在与 ESM 不兼容的语法或模块系统。为解决这个问题尝试关闭 url-loader 的 ESM，改为使用 CJS 模块系统解析文件。</p>
<pre><code class="language-javascript">rules: [ 
  {
    test: /\.(jpg|png|gif)$/, // 默认处理不了 html 中 img 图片
    loader: "url-loader", // 仅使用一个 loader 可以不需要 use
    options: {
      limit: 8 * 1024, // 图片大小小于 8kb =&gt; 被 base64 处理
      esModule: false, 
      name: "[hash:10].[ext]" // 重命名 =&gt; [hash:10] 取图片的 hash 的前 10 位
    }
  },
  {
    test: /\.html$/, // 处理图片除样式引入外的 html 标签引入
    loader: "html-loader" 
  } 
]
</code></pre>
<p>在 webpack 5 中，可以使用 <a href="https://webpack.js.org/guides/asset-modules/#root">Asset Modules</a> 替代之前的 url-loader、file-loader 等加载资源的方式。</p>
<p>Asset Modules 可通过 <code>type</code> 属性来指定资源的类型，webpack 会自动将其转换成合适的模块类型。</p>
<pre><code class="language-js">module.exports = {
  //...
  module: {
    rules: [
      {
        test: /\.(png|jpe?g|gif)$/i,
        type: "asset",
        generator: {
          filename: "images/[name]-[hash][ext]"
        },
        parser: {
          dataUrlCondition: {
            maxSize: 100 * 1024 // 100kb
          }
        }
      }
    ]
  }
}
</code></pre>
<p>在处理特殊字体的资源时，可以使用 file-loader 或者 Asset Modules。</p>
<p>在 Asset Modules 中的 <code>[ext]</code> 占位符会自动包含文件名里的扩展名。故在文件名模板中不需要再显式地添加点号，即可以省略 <code>[ext]</code> 前面的点号，如：<code>[name]-[hash]</code>。但对于其他情况，如使用 file-loader 或 url-loader 时，文件名模板需要显式地添加点号。比如：<code>[name].[ext]</code>。</p>
<pre><code class="language-js">rules: [
  {
    test: /\.(eot|ttf|woff2?)$/i,
    type: "asset/resource",
    generator: {
      filename: "font/[name]_[hash:6][ext]" // 此处为 filename 中写目录
    }
  }
]
</code></pre>
<h3 id="generalplugins">General Plugins</h3>
<blockquote>
<p>While loaders are used to transform certain types of modules, plugins can be leveraged to perform a wider range of tasks like bundle optimization, asset management and injection of env variables.</p>
</blockquote>
<p>在不清空构建目录的情况下，虽然打包所生成的文件会直接覆盖构建目录中的同名文件，但是仍然会有残余的文件被保留下来。可以使用 clean-webpack-plugin 来自动删除构建目录。</p>
<pre><code class="language-js">const { CleanWebpackPlugin } = require("clean-webpack-plugin"); // 引入类

module.exports = {
  ...
  plugins: [ new CleanWebpackPlugin() ]
}
</code></pre>
<p>html-webpack-plugin 可以根据打包后的结果自动生成 HTML，并自动引入打包后的 JS 和 CSS 文件。</p>
<pre><code class="language-javascript">const HtmlWebpackPlugin = require('html-webpack-plugin');

plugins: [
  ...
  new HtmlWebpackPlugin({
    title: "webpack title",
    template: './src/index.html'
  })
]
</code></pre>
<p>html-webpack-plugin 默认使用 ejs 模板引擎来生成 HTML 文件。在自定义模板数据填充时，可以使用 DefinePlugin 在编译时创建全局常量。DefinePlugin 是 Webpack 内置的一个插件。</p>
<pre><code class="language-javascript">const webpack = require('webpack');
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
  // ...
  plugins: [
    new webpack.DefinePlugin({
      APP_TITLE: JSON.stringify('My App'),
      APP_VERSION: JSON.stringify('1.0.0'),
    }),
    new HtmlWebpackPlugin({
      template: 'src/index.ejs',
      filename: 'index.html',
      inject: true,
    }),
  ],
};
</code></pre>
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
  &lt;head&gt;
    &lt;title&gt;&lt;%= APP_TITLE %&gt; - &lt;%= APP_VERSION %&gt;&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;div id="app"&gt;&lt;/div&gt;
  &lt;/body&gt;
&lt;/html&gt;
</code></pre>
<blockquote>
<p>The copy-webpack-plugin copies individual files or entire dirs, which already exist, to the build dir.</p>
</blockquote>
<p>copy-webpack-plugin 会根据 <code>output.path</code> 配置项指定的输出目录自动计算出正确的构建目录，因此在 <code>patterns</code> 中的 <code>to</code> 配置项里可以写相对路径，例如 <code>./</code> 表示输出目录的根目录。若不设置 <code>to</code> 配置项 copy-webpack-plugin 会默认将文件复制到输出目录的根目录下。</p>
<pre><code class="language-javascript">const CopyWebpackPlugin = require('copy-webpack-plugin');

module.exports = {
  // ...
  plugins: [
    new CopyWebpackPlugin({
      patterns: [
        {
          from: 'src/assets',
          to: './',
          globOptions: {
            ignore: [
              '**/index.html', // 忽略 src/assets 目录及其子目录下的所有 index.html 文件
              'src/assets/images', // 忽略 src/assets/images 目录及其子目录
            ],
          },
        },
      ],
    }),
  ],
};
</code></pre>
<h3 id="modularsupport">Modular Support</h3>
<p>webpack 的模块化本质上就是为每个模块创建了一个独立的函数作用域。</p>
<p>在加载模块时，会先根据模块的路径生成一个 <code>moduleId</code>，并将其传递给 <code>__webpack_require__</code> 函数。<code>__webpack_require__</code> 函数会使用这个 <code>moduleId</code> 来获取对应的模块工厂函数，然后调用这个函数来获取模块的导出值。</p>
<p>默认 webpack 会为每个模块生成一个独立的模块工厂函数，并将其存储在 <code>__webpack_modules__</code> 对象（可理解为模块映射）中，键名是模块的路径，值是包装了模块代码的函数。</p>
<pre><code class="language-javascript">// 模块工厂函数加载执行模块
__webpack_modules__[moduleId](module, module.exports, __webpack_require__)
</code></pre>
<h3 id="sourcemap">Source Map</h3>
<p>webpack 中可以通过配置 <a href="https://webpack.js.org/configuration/devtool/">devtool</a> 选项来生成 source-map。source-map 是一种映射关系，可以将编译后的代码映射回原始源码，使得在浏览器控制台中准确地显示出错误和警告的位置，方便定位和调试问题。</p>
<p>webpack 在 <code>mode: "development"</code> 模式下默认设置 <code>devtool: "eval"</code>。这会将每个模块的源代码转换成字符串，并使用 <code>eval</code> 函数对其执行。利用 <code>eval</code> 包裹代码的末尾注释，可以标记每个模块的位置信息、依赖信息以及代码映射关系等，方便在开发者工具中进行调试。</p>
<p>这些注释被称为 sourceURL 和 sourceMappingURL 注释。其中，sourceURL 注释用于标记 <code>eval</code> 包裹的代码对应的源文件路径和行号信息，而 sourceMappingURL 注释用于标记生成的 source map 文件路径。</p>
<p><code>source-map</code> 会生成独立的 source-map，并在打包文件中生成指向 source-map 文件的注释，这个注释通常以 <code>//# sourceMappingURL=</code> 开头，后面跟着 source-map 文件的 URL。这个注释会被浏览器解析，然后自动下载对应的 source-map 文件。</p>
<p><code>eval-source-map</code> 生成的 source-map 是以 DataUrl 的形式添加到 <code>eval</code> 函数后面，而不是作为单独的文件存在。</p>
<p><code>inline-source-map</code> 会将生成的 source-map 以 DataUrl 的形式添加到打包文件的尾部。</p>
<p><code>cheap-source-map</code> 中的 cheap 表示低开销，其生成的 source-map 不包含列映射信息，只包含行映射信息。开发中一般使用行映射信息即可定位异常。</p>
<p><code>cheap-module-source-map</code> 会比 <code>cheap-source-map</code> 包含更多的信息，特别是对于使用了 loader 处理的代码，可以提供更加完整的源代码映射。</p>
<p>常规来说 <code>devtool</code> 的组合规则可以按照如下格式，其中，<code>[inline-|hidden-|eval-]</code> 表示 source map 的嵌入方式，选项 <code>[nosource-]</code> 表示不包含源代码信息，选项 <code>[cheap-[module-]]</code> 表示在仅包含行映射的条件下，是否使用对 loader 转换后的源代码进行更完整信息的显示，最后 <code>source-map</code> 表示生成独立的 source map 文件。</p>
<pre><code class="language-javascript">[inline-|hidden-|eval-][nosource-][cheap-[module-]]source-map
</code></pre>
<p>开发和测试阶段推荐选择 <code>source-map</code> 与 <code>cheap-module-source-map</code>。</p>
<p>为提高代码运行效率和减小文件体积，打包阶段通常不包含源代码映射，推荐缺省或 <code>false</code>。</p>
<h3 id="babel">Babel</h3>
<p><a href="https://babeljs.io/docs/en/">巴别塔 Babel</a> 是一个工具链，可以将 ECMAScript 2015+ 代码转换为支持在当前和旧版本浏览器环境中运行的 JavaScript 版本（向后兼容）。</p>
<p>在开发环境依赖中安装 Babel 核心模块 @babel/core 和命令行工具 @babel/cli。</p>
<ul>
<li>@babel/core 提供了 Babel 的编译功能，包括解析源码、转换和生成目标代码等</li>
<li>@babel/cli 提供了在命令行中使用 Babel 的能力，可以通过命令行参数指定相关的操作</li>
</ul>
<pre><code class="language-shell">$ npm install --save-dev @babel/core @babel/cli
</code></pre>
<p>使用 Babel 来转换箭头函数和块级作用域时，需要额外安装两个插件 @babel/plugin-transform-arrow-functions 和 @babel/plugin-transform-block-scoping。</p>
<pre><code class="language-shell">$ npm install --save-dev @babel/plugin-transform-arrow-functions @babel/plugin-transform-block-scoping
</code></pre>
<pre><code class="language-shell">$ npx babel src --out-dir dist --plugins=@babel/plugin-transform-arrow-functions, @babel/plugin-transform-block-scoping
</code></pre>
<p><a href="https://babeljs.io/docs/en/babel-preset-env">@babel/preset-env</a> 是一个预设插件集合，提供了根据当前的环境自动确定需要使用哪些插件来进行语法转换的能力。@babel/preset-env 预设插件集合在使用时，可以通过设置 <code>targets</code> 选项来指定转换的目标执行环境。这个选项可以是一个对象，也可以是一个字符串。</p>
<pre><code class="language-shell">$ npm install --save-dev @babel/preset-env 
</code></pre>
<pre><code class="language-shell">$ npx babel src --out-dir dist --presets=@babel/preset-env --targets '{"chrome": "58", "ie": "11"}'
</code></pre>
<p>除 <code>targets</code> 以外，@babel/preset-env 还提供了一些其他的选项，用于控制预设插件集合的行为。其中比较常用的有：根据目标环境自动导入所需的 polyfill 的 <code>useBuiltIns</code> 和在控制台输出详细的调试信息，包括每个插件的名称、版本和选项的 <code>debug</code>。<code>.babelrc</code> 或 <code>babel.config.js</code> 中添如下。</p>
<pre><code class="language-javascript">{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "usage", // 自动根据使用的特性来决定是否导入 polyfill
        "corejs": 3,
        "debug": true
      }
    ]
  ]
}
</code></pre>
<p>@babel/polyfill 是一个 JavaScript lib，提供对 ECMAScript 新特性的 polyfill 支持，以使这些特性在旧版浏览器中也可以生效。其包含两个主要的部分：core-js 和 regenerator-runtime。</p>
<p>core-js 是一个模块化的标准库，为 ECMAScript 的各种特性提供 polyfills，以解决不同浏览器之间的兼容性问题。包括 Promise、Map、Set、Reflect、Proxy、Symbol 等。</p>
<pre><code class="language-shell">npm install core-js@3 --save
# or
npm install core-js@2 --save
</code></pre>
<p>regenerator-runtime 是一个运行时库，提供了对于 ECMAScript 6 generators 和 async/await 语法的支持。通常用来处理生成器和异步函数。</p>
<p>提示：@babel/polyfill 在 Babel 7.4.0 中已经被弃用了，建议使用 @babel/preset-env 中的 useBuiltIns 选项来引入需要的 polyfill。只需指定 corejs 版本，不需要额外指定 regenerator-runtime。</p>
<p>插件 @babel/plugin-transform-runtime 可以将代码中使用到的一些辅助函数进行替换，以实现在不污染全局命名空间的情况下使用（如 Object.assign、Promise、Symbol 等）。这可以解决 polyfill 机制中将新增的静态方法和实例方法直接添加到全局变量或全局变量原型上的问题（与第三方库产生冲突）。</p>
<pre><code class="language-shell">yarn add @babel/plugin-transform-runtime -D
</code></pre>
<pre><code class="language-javascript">{
  "presets": [
    [
      "@babel/preset-env",
      {
        "useBuiltIns": "usage", // 如果 @babel/plugin-transform-runtime 配置了 corejs:3 =&gt; preset-env 的 useBuiltIns 就不会生效
        "debug": true,
        "targets": {
          "ie": 10
        },
        "comments": false // 不产生注释
      }
    ]
  ],
  "plugins": [
    [
      // 转换为引用 babel-runtime/regenerator 和 babel-runtime/core-js 模块中的方法
      "@babel/plugin-transform-runtime",
      {
        "corejs": 3 // 指定 runtime-corejs 的版本 =&gt; 目前有 2、3
      }
    ]
  ]
}
</code></pre>
<p>Babel 的执行过程其实和很多编译器的工作原理是类似的。</p>
<ul>
<li>解析：使用解析器 Parser 将源码解析成 AST 抽象语法树</li>
<li>转换：使用转换器 Transformer 对 AST 进行修改，并应用插件 Plugins 对特定的语法进行转化</li>
<li>生成：使用生成器 Generator 将修改后的 AST 转换为目标代码，可以被 V8 引擎解释执行</li>
</ul>
<p>解析一般包括词法分析和语法分析两个阶段。词法分析会将源代码转换成记号流，而语法分析会分析这些 tokens 流并将其转换成一颗抽象语法树 AST。</p>
<p>当需要将 TypeScript 转换为 JavaScript 时，可以结合使用 babel-loader 与 tsc，以弥补这两者各自的不足。babel-loader 在编译时不会对类型错误进行检测，仅使用 tsc 会缺少解决兼容性问题的 polyfill。</p>
<p>具体可以在 <code>package.json</code> 中添加脚本 <code>"type-check-watch": "tsc --noEmit --watch"</code> 来开启类型检查，在 webpack 中使用 babel-loader 进行编译转换和解决兼容性的问题。</p>
<h2 id="advancedsupport">Advanced Support</h2>
<h3 id="transitionsforvuesfc">Transitions for Vue SFC</h3>
<p>在将 Vue 单文件组件转换为 JavaScript 模块时，需要借助 vue-loader 与 vue-template-compiler。前者可以将一个 <code>.vue</code> 文件转换为 JavaScript 对象。后者会将 <code>.vue</code> 文件中的 <code>&lt;template&gt;</code> 标签编译为渲染函数，最终生成实际的 DOM 结构并进行渲染，以便在浏览器中可以显示相关的组件。</p>
<pre><code class="language-shell">$ npm install vue-loader vue-template-compiler -D
</code></pre>
<p>配置 vue-loader 时需要在 webpack 的配置文件中使用 <code>VueLoaderPlugin</code> 插件。具体来说，需要在配置文件中的 <code>plugins</code> 数组中创建一个 <code>VueLoaderPlugin</code> 的实例，并将其作为插件添加进去。</p>
<pre><code class="language-javascript">const VueLoaderPlugin = require('vue-loader/lib/plugin');

module.exports = {
  // ...其他配置
  module: {
    rules: [
      {
        test: /\.vue$/,
        loader: 'vue-loader'
      },
      // ...其他规则
    ]
  },
  plugins: [
    new VueLoaderPlugin()
  ]
};
</code></pre>
<h3 id="devserverandhmr">DevServer and HMR</h3>
<p>通常在开发阶段需要频繁地修改和测试代码，如果每次都通过手动编译和刷新浏览器，那么开发效率就会受到影响，此时可以使用 devServer 在内存中编译打包，并提供一个自动刷新浏览器的开发环境。</p>
<p>虽然使用 <code>watch</code> 参数或者 live-server 插件也可以实现代码修改后的页面更新，但效率不如 devServer 高。因为 <code>watch</code> 参数或者 live-server 插件都是直接刷新整个页面，而 devServer 是通过 HMR 热模块替换技术实现了页面的局部更新，从而避免了刷新整个页面的开销。</p>
<pre><code class="language-javascript">...
module.exports = {
  mode: 'development',
  devServer: {
    contentBase: resolve(__dirname, 'build'), // 项目构建后路径
    compress: true, // 启动 gzip 压缩
    port: 3000, // 端口号 
    open: true // 自动打开浏览器 
  } 
};
</code></pre>
<p>需要<a href="https://stackoverflow.com/questions/40379139/cannot-find-module-webpack-bin-config-yargs">注意的是 webpack-cli 的版本</a>，webpack-cli 4 已经将 devServer 的实现方式进行了重构，需要使用 <code>webpack serve</code> 来启动开发服务器，而 webpack-cli 4 以前的版本，使用 <code>webpack-dev-server</code>。</p>
<p>webpack-dev-middleware 是一个 Express 中间件，可以将 webpack 打包的文件传递给服务器，并且可以将打包结果缓存到内存中，以便在文件发生变化时自动重新构建。</p>
<pre><code class="language-javascript">const express = require('express');
const webpack = require('webpack');
const webpackDevMiddleware = require('webpack-dev-middleware');

const app = express();
const config = require('./webpack.config.js');
const compiler = webpack(config);

app.use(webpackDevMiddleware(compiler, {
  publicPath: config.output.publicPath
}));

app.listen(3000, function () {
  console.log('App listening on port 3000!\n');
});
</code></pre>
<p>如果没有在入口文件中通过 <code>module.hot.accept</code> 函数来指定需要开启 HMR 的模块，那么默认情况下只有在根模块发生变化时，整个应用程序才会被热更新，而其他模块则会触发完整刷新。<a href="https://webpack.js.org/api/hot-module-replacement/">点此查看</a></p>
<pre><code class="language-javascript">if (module.hot) {
  module.hot.accept('./your-module', function() {
    // 当 './your-module' 模块更新后执行的逻辑
  })
}
</code></pre>
<p>在使用 Vue 或 React 框架开发时，社区已经提供了比较成熟的 HMR 解决方案，<a href="https://webpack.js.org/guides/hot-module-replacement/#other-code-and-frameworks">点此查看</a>。注意 React Hot Loader 现已被官方弃用，改为 <a href="https://github.com/facebook/react/issues/16604">react-refresh</a> 方案。</p>
<p>HMR 热更新的实现原理是 webpack-dev-server 或 webpack-dev-middleware 将打包好的文件传递给服务器 Express，同时建立一个长连接的 socket 服务，监听文件的变化事件。当某个模块的代码发生变化时，webpack 会重新打包这个模块的代码，然后通过 socket 服务推送给客户端的浏览器。</p>
<h3 id="codesplitting">Code Splitting</h3>
<p>代码分割作为一种常规的优化手段，可以将打包后的代码拆分成多个小块，然后可以按需加载或并行加载这些文件。</p>
<p>在使用入口起点的方式进行代码分割时，每个入口文件都会被单独的打包。同时，还可以使用的<a href="https://webpack.docschina.org/concepts/under-the-hood/#output">占位符</a>来指明打包后的 bundle 文件名。</p>
<pre><code class="language-javascript">module.exports = {
  entry: {
    app: './src/app.js',
    vendor: './src/vendor.js'
  },
  output: {
    filename: '[name].[contenthash:8].js',
    path: __dirname + '/dist'
  }
};
</code></pre>
<p>当多个入口文件使用了相同的第三方包时，如果不进行处理，这些第三方包可能会被重复打包，导致打包后的文件体积过大。为避免这种情况，可使用 <a href="https://webpack.js.org/configuration/entry-context/"><code>Entry dependencies</code></a> 和 <a href="https://webpack.js.org/plugins/split-chunks-plugin/"><code>SplitChunksPlugin</code></a>。</p>
<p>注意，<a href="https://webpack.docschina.org/plugins/split-chunks-plugin/#splitchunkschunks"><code>optimization.splitChunks</code></a> 中要被分割的代码块默认值是 <code>async</code>，这意味着只有使用了异步加载的代码块才会被分割。</p>
<h3 id="prodenvconfiguration">prod-env configuration</h3>
<ul>
<li>提取 css 成单独文件</li>
</ul>
<p>样式经过处理整合在 <code>.js</code> 中（css-loader）会使 <code>.js</code> 体积非常大，下载速度慢。同时必须先加载才能创建标签加载在页面中，这里又会出现闪屏现象。故需要将 <code>.css</code> 文件从 <code>.js</code> 文件提取出来。又考虑代码体积较大，需要进行压缩处理。部分样式代码与 <code>.js</code> 代码存在兼容问题，如部分 CSS3 需要加上前缀才可以在低版本进行运行。<a href="https://webpack.js.org/plugins/mini-css-extract-plugin/">详细信息点此</a>。</p>
<pre><code class="language-shell"># 下载插件
npm install --save-dev mini-css-extract-plugin
</code></pre>
<pre><code class="language-javascript">const { resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
module.exports = {
  entry: './src/js/index.js',
  output: {
    filename: 'js/built.js',
    path: resolve(__dirname, 'build')
  },
  module: {
    rules: [
      { 
        test: /\.css$/,
        use: [ 
          // 创建 style 标签，将样式放入 
          // 'style-loader', 
          // 这个 loader 取代 style-loader。作用：提取 js 中的 css 成单独文件 
          MiniCssExtractPlugin.loader, // 不需要引号
          // 将 css 文件整合到 js 文件中 
          'css-loader' 
        ] 
      } 
    ] 
  },
  plugins: [ 
    new HtmlWebpackPlugin({ 
      template: './src/index.html' 
    }), 
    new MiniCssExtractPlugin({ 
      // 对输出的 css 文件进行重命名 
      filename: 'css/built.css' 
    }) 
  ],
  mode: 'development' 
};
</code></pre>
<ul>
<li>js 压缩与 html 压缩</li>
</ul>
<h2 id="optimization">Optimization</h2>
<p>优化前端性能其实是指优化打包的输出结果。</p>
<p>压缩代码可以利用 uglifyjs-webpack-plugin 和 ParallelUglifyPlugin</p>
<p>压缩代码：删除多余的代码、注释、简化<br />
代码的写法等等方式。可以利用 webpack<br />
的 UglifyJsPlugin 和 ParallelUglifyPlugin<br />
来压缩JS文件，利用 cssnano (css-<br />
loader?minimize） 来压缩css<br />
利用 CDN加速：在构建过程中，将引用的<br />
静态资源路径修改为CDN上对应的路径。<br />
可可以利用webpack对于output 参数和各<br />
loader的publicPath 参数来修改资源路径<br />
Tree Shaking：将代码中永远不会走到的片<br />
段删除掉。可以通过在启动webpack时追<br />
加参数--optimize-minimize 来实现<br />
Code Splitting： 将代码按路由维度或者组<br />
件分块(chunk),这样做到按需加载,同时可<br />
以充分利用浏览器缓存<br />
提取公共第三方库：SplitChunksPlugin插件<br />
来进行公共模块抽取,利用浏览器缓存可以<br />
长期缓存这些无需频繁变动的公共代码</p>
<h3 id>开发环境优化</h3>
<p>开发环境优化指优化打包构建速度（调试、开发友好）、优化代码调试（提醒开发代码错误位置）。</p>
<ul>
<li>HMR(Hot Module Replace)</li>
</ul>
<p>热模块替换即一个模块发生变化，只需重新打包这一个模块，而并重新打包全部模块。本地代码改变，重新编译、刷新浏览器即为热更新。HMR 功能对于 <code>.js</code> 的处理只能处理非入口文件的其他文件。入口文件进行 HMR 则所有文件都会重新打包。</p>
<table>
<thead>
<tr>
<th>文件</th>
<th>热更新</th>
</tr>
</thead>
<tbody>
<tr>
<td>样式文件</td>
<td>可以使用 HMR功能，因为 style-loader 内部已实现</td>
</tr>
<tr>
<td>JS 文件</td>
<td>默认不能使用 HMR 功能</td>
</tr>
<tr>
<td>html 文件</td>
<td>默认不能使用 HMR，只有一个文件不需要考虑 HMR 功能</td>
</tr>
</tbody>
</table>
<pre><code class="language-javascript">...
devServer: { // 修改 webpack 配置一定要重启 webpack 服务
  ...,
  hot: true // 开启 HMR 功能
}
</code></pre>
<pre><code class="language-javascript">...
import print from './print.js'
if(module.hot) { // 一旦 module.hot 为 true 则开启 HMR 属性 -- 让 HMR 功能生效
  module.hot.accept('./print.js', function(){ // 这里的 print.js 已经存在
    // 方法监听 print.js 文件变化, 一旦变化其他默认不会重新打包构建
    // 执行后面的回调函数
    print();
  })
}
</code></pre>
<ul>
<li>oneOf</li>
</ul>
<p>在匹配 loader 时会进行多次匹配，使用 <code>oneOf</code> 表示一下数组中的 loader 仅会匹配一个，节省时间与功耗。类似于 React 的 Switch。</p>
<pre><code class="language-javascript">const { resolve } = require('path');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const OptimizeCssAssetsWebpackPlugin = require('optimize-css-assets-webpack-plugin' );
const HtmlWebpackPlugin = require('html-webpack-plugin');
// 定义 nodejs 环境变量: 决定使用 browserslist 的哪个环境 
process.env.NODE_ENV = 'production';
// 复用 loader 
const commonCssLoader = [
  MiniCssExtractPlugin.loader,
  'css-loader',
  { 
    loader: 'postcss-loader',
    options: {
      ident: 'postcss', 
      plugins: () =&gt; [require('postcss-preset-env')()] 
    } 
  } 
];
module.exports = {
  entry: './src/js/index.js',
  output: { filename: 'js/built.js', path: resolve(__dirname, 'build') },
  module: { 
    rules: [
      {
        // 以下 loader 只会匹配一个 节省时间与内存损耗
        // 注意: 不能两个 loader 处理同一个文件
        { // 在 package.json 中 eslintConfig --&gt; airbnb 
        		test: /\.js$/,
        		exclude: /node_modules/,
        		// 优先执行 不论放在哪里的位置!!!
        		enforce: 'pre', 
        		loader: 'eslint-loader',
        		options: { fix: true }
      		}
      },
      {
        oneOf: [
          { test: /\.css$/, use: [...commonCssLoader] },
      		{ test: /\.less$/, use: [...commonCssLoader, 'less-loader'] },
        	// 不能两个 loader 处理同一类文件 -- 提出
      		/* { // 在 package.json 中 eslintConfig --&gt; airbnb 
        		test: /\.js$/,
        		exclude: /node_modules/,
        		// 优先执行 不论放在哪里的位置!!!
        		enforce: 'pre', 
        		loader: 'eslint-loader',
        		options: { fix: true }
      		}, */
      		{
        		test: /\.js$/,
        		exclude: /node_modules/,
        		loader: 'babel-loader',
        		options: {
          		presets: [
            		[
              		'@babel/preset-env',
              		{
                		useBuiltIns: 'usage', corejs: {version: 3},
                		targets: { chrome:'60', firefox: '50' }
              		}
            		]
          		]
        		}
      		},
      		{ 
        		test: /\.(jpg|png|gif)/,
        		loader: 'url-loader',
        		options: { limit: 8 * 1024, name: '[hash:10].[ext]', outputPath: 'imgs', esModule: false }
      		},
            { test: /\.html$/, loader: 'html-loader' },
      		{ 
        		exclude: /\.(js|css|less|html|jpg|png|gif)/,
        		loader: 'file-loader',
        		options: { outputPath: 'media' }
      		}
        ]
      }	
    ]
  },
  plugins:[ 
    new MiniCssExtractPlugin({ filename: 'css/built.css' }),
    new OptimizeCssAssetsWebpackPlugin(),
    new HtmlWebpackPlugin({ 
      template: './src/index.html',
      minify: { collapseWhitespace: true, removeComments: true}
    })
  ],
  mode: 'production' 
};
</code></pre>
<ul>
<li>babel 缓存</li>
</ul>
<p>考虑生产环境能用 HMR 功能，因为 HMR 基于 devServer 。在 babel 进行翻译时，应该时更改文件变化而其他文件不变，此时应该开启 babel 缓存，将之前编译好的文件进行缓存处理。如果文件没有变化则直接使用缓存而不是再构建一次。</p>
<pre><code class="language-javascript">...{ 
  // babel 缓存
  test: /\.js$/, 
  exclude: /node_modules/, 
  loader: 'babel-loader', 
  options: { 
    presets: [ 
      [ 
        '@babel/preset-env', 
        { 
          useBuiltIns: 'usage', 
          corejs: { version: 3 },
          targets: { chrome: '60', firefox: '50' } 
        } 
      ]
    ],
    // 开启 babel 缓存 
    // 第二次构建时，会读取之前的缓存 
    cacheDirectory: true 
  } 
},...
</code></pre>
<p>文件资源缓存修改文件名——增加 hash 值。<strong>每次构建 webpack 生成唯一的 hash 值</strong>。那么会因为 <code>.js</code> 和 <code>.css</code> 使用唯一一个 hash 值导致所有缓存失效（改动一个文件）。那么考虑 chunkhash 值，根据 chunk 生成的 hash 值，如果打包来<strong>源于同一个 chunk</strong> ，那么 hash 值一样。（所有根据入口文件被引入的文件都会生成一个 chunk）。最终选择 contenthash ，<strong>根据文件内容生成 hash 值</strong>，不同文件 hash 值一定不一样。</p>
<pre><code class="language-javascript">const { resolve } = require('path');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const OptimizeCssAssetsWebpackPlugin = require('optimize-css-assets-webpack-plugin' );
const HtmlWebpackPlugin = require('html-webpack-plugin');
// 定义 nodejs 环境变量：决定使用 browserslist 的哪个环境 
process.env.NODE_ENV = 'production'; 
// 复用 loader
const commonCssLoader = [ 
  MiniCssExtractPlugin.loader,
  'css-loader',
  { // 还需要在 package.json 中定义 browserslist
    loader: 'postcss-loader',
    options: {
      ident: 'postcss',
      plugins: () =&gt; [require('postcss-preset-env')()] } 
  }
];
module.exports = { 
  entry: './src/js/index.js',
  output: {
    // contenthash
    filename: 'js/built.[contenthash:10].js',
    path: resolve(__dirname, 'build')
  },
  module: {
    rules: [
      { // 在 package.json 中 eslintConfig --&gt; airbnb
        test: /\.js$/, exclude: /node_modules/,
        // 优先执行 
        enforce: 'pre',
        loader: 'eslint-loader',
        options: { fix: true } 
      },
      { 
        // 以下 loader 只会匹配一个
        // 注意：不能有两个配置处理同一种类型文件
        oneOf: [
          { test: /\.css$/, use: [...commonCssLoader] },
          { test: /\.less$/, use: [...commonCssLoader, 'less-loader'] },
          /*正常来讲，一个文件只能被一个 loader 处理。 当一个文件要被多个 loader 处理，那么一定要指定 loader 执行的先后顺序： 先执行 eslint 在执行 babel */
          {
            test: /\.js$/,
            exclude: /node_modules/,
            loader: 'babel-loader',
            options:
            {
              presets:[
                [
                  '@babel/preset-env',
                  {
                    useBuiltIns: 'usage',
                    corejs: { version: 3 },
                    targets: { chrome: '60', firefox: '50' }
                  }
                ]
              ],
							// 开启 babel 缓存 
							// 第二次构建时，会读取之前的缓存 
              cacheDirectory: true
            }
          },
          {
            test: /\.(jpg|png|gif)/,
            loader: 'url-loader',
            options: { limit: 8 * 1024, name: '[hash:10].[ext]', outputPath: 'imgs', esModule: false } },
          {
            test: /\.html$/,
            loader: 'html-loader'
          },
          {
            exclude: /\.(js|css|less|html|jpg|png|gif)/,
            loader: 'file-loader',
            options: { outputPath: 'media' } 
          } 
        ] 
      } 
    ] 
  },
  plugins: [
    // contenthash
    new MiniCssExtractPlugin({ filename: 'css/built.[contenthash:10].css' }),
    new OptimizeCssAssetsWebpackPlugin(),
    new HtmlWebpackPlugin({
      template: './src/index.html',
      minify: { collapseWhitespace: true, removeComments: true } 
    }) 
  ],
  mode: 'production',
  devtool: 'source-map' 
};
</code></pre>
<ul>
<li><a href="https://webpack.js.org/guides/tree-shaking/#root">Tree Shaking</a></li>
</ul>
<p>tree shaking 可移除 JavaScript 上下文中未引用的代码，优化打包体积。利用 ES6 的模块化规范引入静态分析，故而可以在编译的时候判断实际加载的具体模块，以及未被使用的变量或者引用，进而删除对应代码。当配置文件中的 mode 开启生产环境 production 时，会被默认开启。</p>
<blockquote>
<p>所有导入的文件都会受到 tree shaking 的影响。若在项目中使用类似 css-loader 并 import CSS 文件，则需要将其添加到 side effect 列表中，以免在生产模式中无意的被删除。</p>
</blockquote>
<blockquote>
<p>side effect 的定义是在导入时会执行特殊行为的代码，而不是仅仅暴露一个 export 或多个 export。</p>
</blockquote>
<p>package.json 中设置 <code>"sideEffects": false</code>，表示所有代码都无副作用，都可进行 tree shaking。</p>
<p>为避免误删样式文件，应当修改为 <code>"sideEffects": ["*.css", "*.less"]</code></p>
<pre><code class="language-json">{
  "name": "your-project",
  "sideEffects": ["./src/some-side-effectful-file.js", "*.css", "*.less"]
}
</code></pre>
<ul>
<li><a href="https://webpack.js.org/guides/code-splitting/">Code Splitting</a></li>
</ul>
<p>主要将 .js 代码按路由维度或者组件分块 chunks，完成按需加载，同时也可以充分利用浏览器缓存。</p>
<pre><code class="language-javascript">const { resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
module.exports = {
  // 单入口 
  // entry: './src/js/index.js',
  entry: {
    index: './src/js/index.js',
    test: './src/js/test.js'
  },
  output: {
    // [name]：取文件名
    filename: 'js/[name].[contenthash:10].js',
    path: resolve(__dirname, 'build') 
  },
  plugins: [
    new HtmlWebpackPlugin({ template: './src/index.html', minify: { collapseWhitespace: true, removeComments: true } }) ],
  /*1. 可以将 node_modules 中代码单独打包一个 chunk 最终输出 2. 自动分析多入口 chunk 中，有没有公共的文件。如果有会打包成单独一个 chunk */
  optimization: { splitChunks: { chunks: 'all' } },
  mode: 'production'
};
</code></pre>
<ul>
<li><a href="https://webpack.js.org/guides/progressive-web-application/#root">Progressive Web Applications</a></li>
</ul>
<p>渐进式网络开发应用可以提供离线访问功能，即可将 web app 改造为 PWA。通常使用插件 workbox-webpack-plugin 创建 Service Worker 完成此功能。</p>
<pre><code class="language-javascript">// package.json
// 避免 eslint 不认识 window、navigator此类变量
"eslintConfig": {
  "extends": "airbnb-base",
    "env": {
      // 支持浏览器中变量
      "browser": true
    }
}
</code></pre>
<pre><code class="language-javascript">// src/index.js
...
// 注意此处 serviceWorker 中 w 首字母大写
if('serviceWorker' in navigator) {
  window.addEventListener('load', () =&gt; {
    navigator.serviceworker.register('/service-worker.js')
    .then(() =&gt; {
      console.log('sw注册成功~')
    })
    .catch(() =&gt; {
      console.log('sw注册失败~')
    })
  })
}
</code></pre>
<pre><code class="language-javascript">...
plugins: [
  new MiniCssExtractPlugin({ filename: 'css/built.[contenthash:10].css' }),
  new OptimizeCssAssetsWebpackPlugin(),
  new HtmlWebpackPlugin({
    template: './src/index.html',
    minify: { collapseWhitespace: true, removeComments: true }
  }),
  new WorkboxWebpackPlugin.GenerateSW({
    /*1. 帮助 serviceworker 快速启动 2. 删除旧的 serviceworker 生成一个 serviceworker 配置文件~ */
    clientsClaim: true,
    skipWaiting: true 
  })
],...
</code></pre>
<p>上述的 sw 代码必须运行在服务器上，可通过 serve 快速启动服务器</p>
<pre><code class="language-shell">npm i serve -g
serve -s build # 启动服务器
</code></pre>
<ul>
<li><a href="https://webpack.js.org/loaders/thread-loader/#root">多进程打包</a></li>
</ul>
<p>JavaScript 主线程引擎是单线程的，同一时间只能做一件事。可以通过多进程优化打包速度。进程启动大概需要几百毫秒，且进程通信也有开销。只有当工作时间消耗较长时，才会选择多进程打包。</p>
<pre><code class="language-shell"># 下载安装包, 通常给 babel-loader 使用
npm install --save-dev thread-loader
</code></pre>
<pre><code class="language-javascript">...{
  test: /\.js$/,
	exclude: /node_modules/,
	use: [
    /*开启多进程打包。 进程启动大概为 600ms，进程通信也有开销。 只有工作消耗时间比较长，才需要多进程打包 */
    {
      loader: 'thread-loader',
      options: {
        workers: 2 // 进程 2 个
			}
    },...
</code></pre>
<p>externals 和 DllPlugin/DllReferencePlugin/AddAssetHtmlPlugin</p>
<p>miminize 和 minimizer</p>
<ul>
<li>dll</li>
</ul>
<p>如果对第三方库（jquery、react、vue...）打包成一个文件体积会太大，通过 dll 可以将库拆开打包成不同的 chunk 文件。</p>
<pre><code class="language-shell"># 下载插件
npm i add-asset-html-webpack-plugin -D
</code></pre>
<pre><code class="language-javascript">const HtmlWebpackPlugin = require('html-webpack-plugin');
const webpack = require('webpack');
const AddAssetHtmlWebpackPlugin = require('add-asset-html-webpack-plugin');
module.exports = {
  entry: './src/index.js',
  output: {
    filename: 'built.js', path: resolve(__dirname, 'build')
  },
  plugins: [
    new HtmlWebpackPlugin({ template: './src/index.html' }),
    // 告诉 webpack 哪些库不参与打包，同时使用时的名称也得变~ 
    new webpack.DllReferencePlugin({ manifest: resolve(__dirname, 'dll/manifest.json') }),
    // 将某个文件打包输出去，并在 html 中自动引入该资源 
    new AddAssetHtmlWebpackPlugin({ filepath: resolve(__dirname, 'dll/jquery.js') }) ],
  mode: 'production' 
};
</code></pre>
<p>相比于 external 彻底不打包，需要 cdn 连接进来，而 dll 需要打包一次，将来不需要重复打包。</p>
<h2 id="webpack">webpack 配置详情</h2>
<h3 id="entry">entry</h3>
<pre><code class="language-javascript">const { resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
module.exports = {
  entry: {
    index: ['./src/index.js', './src/count.js'],
    add: './src/add.js' 
  },
  output: { filename: '[name].js', path: resolve(__dirname, 'build') },
  // 如果传入 template 会以某个文件为模板去创建 html; 直接写会创建空的新 html 文件
  plugins: [new HtmlWebpackPlugin()],
  mode: 'development'
};
</code></pre>
<ol>
<li>string --&gt; './src/index.js'，单入口打包形成一个 chunk。 输出一个 bundle 文件。此时 chunk 的名称默认是 main。</li>
<li>array --&gt; ['./src/index.js', './src/add.js']，多入口所有入口文件最终只会形成一个 chunk，输出出去只有一个 bundle 文件。（一般只用在 HMR 功能中让 html 热更新生效） <code>react:['react', 'react-dom', 'react-router-dom']</code></li>
<li>object，多入口有几个入口文件就形成几个 chunk，输出几个 bundle 文件，此时 chunk 的名称是 key 值。</li>
<li>特殊用法：多入口打包成一个 chunk，再分别打包</li>
</ol>
<pre><code class="language-javascript">entry: { // bundle 是由 chunk 组成
  // 最终只会形成一个chunk, 输出出去只有一个bundle文件
  index: ['./src/index.js', './src/count.js'], 
  // 形成一个chunk, 输出一个bundle文件。
  add: './src/add.js'
}
</code></pre>
<h3 id="output">output</h3>
<pre><code class="language-javascript">output: {
  // 文件名称（指定名称+目录）
  filename: 'js/[name].js',
  // 输出文件目录（将来所有资源输出的公共目录）
  path: resolve(__dirname, 'build'),
  // 所有资源引入公共路径前缀 --&gt; 'imgs/a.jpg' --&gt; '/imgs/a.jpg'
  publicPath: '/',
  chunkFilename: 'js/[name]_chunk.js', // 指定非入口chunk的名称
  library: '[name]', // 打包整个库后向外暴露的变量名
  libraryTarget: 'window' // 变量名添加到哪个上 browser：window
  // libraryTarget: 'global' // node：global
  // libraryTarget: 'commonjs' // conmmonjs模块 exports
},
</code></pre>
<h3 id="module">module</h3>
<pre><code class="language-javascript">const { resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
module.exports = {
  entry: './src/index.js',
  output: { filename: 'js/[name].js', path: resolve(__dirname, 'build') },
  module: {
    rules: [
      // loader 的配置
      { test: /\.css$/,
       // 多个 loader 用 use
       use: ['style-loader', 'css-loader']
      },
      { test: /\.js$/,
       // 排除 node_modules 下的 js 文件
       exclude: /node_modules/,
       // 只检查 src 下的 js 文件
       include: resolve(__dirname, 'src'),
       // 优先执行
       enforce: 'pre',
       // 延后执行 // enforce: 'post',
       // 单个 loader 用 loader
       loader: 'eslint-loader',
       options: {}
      },
      { // 以下配置只会生效一个
        oneOf: []
      }
    ]
  },
  plugins: [new HtmlWebpackPlugin()],
  mode: 'development'
};
</code></pre>
<h3 id="resolve">resolve</h3>
<pre><code class="language-javascript">const { resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
module.exports = {
  entry: './src/js/index.js',
  output: { filename: 'js/[name].js', path: resolve(__dirname, 'build') },
  module: { rules: [ { test: /\.css$/, use: ['style-loader', 'css-loader'] } ] },
  plugins: [new HtmlWebpackPlugin()],
  mode: 'development',
  // 解析模块的规则
  resolve: {
    // 配置解析模块路径别名: 优点简写路径 缺点路径没有提示
    alias: { $css: resolve(__dirname, 'src/css') },
    // 配置省略文件路径的后缀名
    extensions: ['.js', '.json', '.jsx', '.css'],
    // 告诉 webpack 解析模块是去找哪个目录 -- 当前目录找不到会去上一层目录
    modules: [resolve(__dirname, '../../node_modules'), 'node_modules']
  }
};
</code></pre>
<h3 id="devserver">dev server</h3>
<pre><code class="language-javascript">const { resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
module.exports = {
  entry: './src/js/index.js',
  output: { filename: 'js/[name].js', path: resolve(__dirname, 'build') },
  module: { rules: [ { test: /\.css$/, use: ['style-loader', 'css-loader'] } ] },
  plugins: [new HtmlWebpackPlugin()],
  mode: 'development',
  resolve: {
    alias: { $css: resolve(__dirname, 'src/css') },
    extensions: ['.js', '.json', '.jsx', '.css'],
    modules: [resolve(__dirname, '../../node_modules'), 'node_modules']
  },
  devServer: {
    // 运行代码的目录 contentBase: resolve(__dirname, 'build'),
    // 监视 contentBase 目录下的所有文件，一旦文件变化就会 reload
    watchContentBase: true,
    watchOptions: {
      // 忽略文件 —— 高效
      ignored: /node_modules/
    },
    // 启动 gzip 压缩
    compress: true,
    // 端口号
    port: 5000,
    // 域名
    host: 'localhost',
    // 自动打开浏览器
    open: true,
    // 开启 HMR 功能
    hot: true,
    // 不要显示启动服务器日志信息
    clientLogLevel: 'none',
    // 除了一些基本启动信息以外，其他内容都不要显示
    quiet: true,
    // 如果出错了，不要全屏提示~
    overlay: false,
    // 服务器代理 --&gt; 解决开发环境跨域问题
    proxy: {
      // 一旦 devServer(5000)服务器接受到 /api/xxx 的请求，就会把请求转发到另外一个服务器 (3000)
      '/api': { target: 'http://localhost:3000',
               // 发送请求时，请求路径重写：将 /api/xxx --&gt; /xxx （去掉/api）
               pathRewrite: { '^/api': '' }
              }
    }
  }
};
</code></pre>
<h3 id="optimization">optimization</h3>
<pre><code class="language-javascript">const { resolve } = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');
const TerserWebpackPlugin = require('terser-webpack-plugin');
module.exports = {
  entry: './src/js/index.js',
  output: {
    filename: 'js/[name].[contenthash:10].js',
    path: resolve(__dirname, 'build'),
    chunkFilename: 'js/[name].[contenthash:10]_chunk.js'
  },
  module: { rules: [ { test: /\.css$/, use: ['style-loader', 'css-loader'] } ] },
  plugins: [new HtmlWebpackPlugin()],
  mode: 'production',
  resolve: {
    alias: {
      $css: resolve(__dirname, 'src/css')
    },
    extensions: ['.js', '.json', '.jsx', '.css'],
    modules: [resolve(__dirname, '../../node_modules'), 'node_modules']
  },
  optimization: {
    splitChunks: {
      chunks: 'all' // 默认值，可以不写~ ,
      minSize: 30 * 1024, // 分割的 chunk 最小为 30kb
      maxSize: 0, // 最大没有限制
      minChunks: 1, // 要提取的 chunk 最少被引用 1 次
      maxAsyncRequest: 5, // 按需加载并行加载文件最大数量
      maxInitialRequests: 3, // 入口js文件最大并行请求数量
      automaticNameDelimiter: '~' , // 名称连接符
      name: true, // 可以命名规则
      cacheGroups: { // 分割chunk组
      	vendors：{ // node_modules文件被打包到 vendors 组的 chunk 中 --&gt; vendors~xxx.js
      		test: /[||/]node_modules[\\/]/,
      		priority: -10
   			},
    		default: {
      		minChunks: 2, // 被提取的 chunk 至少被引用两次
          priority: -10,
          // 当前打包木块和之前被提取模块是同一个则可以复用
          reuseExistingChunk: true
    		}
    	}
    },
    // 将当前模块的记录其他模块的 hash 单独打包为一个文件 runtime
    // 解决：修改 a 文件导致 b 文件的 contenthash 变化 -- 某一个文件修改导致 hash 变化导致缓存失效
    runtimeChunk: { name: entrypoint =&gt; `runtime-${entrypoint.name}` },
    minimizer: [
      // 配置生产环境的压缩方案：js 和 css
      new TerserWebpackPlugin({
        // 开启缓存
        cache: true,
        // 开启多进程打包
        parallel: true,
        // 启动 source-map
        sourceMap: true })
    ]
  }
}; 
</code></pre>
<h2 id="tipsandhints">Tips and Hints</h2>
<h3 id="operatorsand">Operators &amp;&amp; and &amp;</h3>
<p>&amp;&amp; 运算符会将两个命令连接起来，并当第一个命令执行成功后再执行第二个命令。</p>
<p>&amp; 运算符是将两个命令同时执行，不需要等待第一个命令的执行完毕，常用于同时执行多个任务。</p>
<h3 id="publicpathinoutputanddevserver">publicPath in output and devServer</h3>
<p>配置项 <code>output.publicPath</code> 和 <code>devServer.publicPath</code> 都是相对于打包输出目录的 URL，这个选项会成为引用静态资源时的前缀。两者的区别是客户端访问静态资源和访问开发服务器上的静态资源。</p>
<h3 id="entryandcontext">Entry and Context</h3>
<blockquote>
<p>The <a href="https://webpack.js.org/configuration/entry-context/#context">context</a> is the base directory, an absolute path, for resolving entry points and loaders from the configuration.</p>
</blockquote>
<p><code>entry</code> 通常使用相对路径，并且相对于配置中的 <code>context</code> 属性。<code>context</code> 属性是一个用于解析相对路径的绝对路径，这个绝对路径可以是任何存在的目录，但通常会选择项目的根目录作为上下文。</p>
<h3 id="filenameandchunkfilename">Filename and ChunkFilename</h3>
<p><code>output.filename</code> 用于指定入口起点生成的 bundle 文件名，而 <code>output.chunkFilename</code> 用于指定非入口起点生成的文件名。</p>
<h3 id="webpackdevserver">webpack-dev-server 兼容问题</h3>
<p>运行<code>webpack-dev-server</code>出现如下报错</p>
<pre><code class="language-javascript">&gt; webpack-dev-server

internal/modules/cjs/loader.js:883
  throw err;
  ^

Error: Cannot find module 'webpack-cli/bin/config-yargs'
</code></pre>
<p>报错内容为找不到 webpack-cli 中对应模块。报错时项目相应 webpack 配置如下：</p>
<pre><code class="language-javascript">"webpack": "^5.24.3",
"webpack-cli": "^4.5.0",
"webpack-dev-server": "^3.11.2"
</code></pre>
<p>解决方案：</p>
<ul>
<li>方法一:重装 webpack-cli 与 webpack-dev-server 兼容的版本;</li>
<li>方法二:修改 <code>package.json</code> 文件中 <code>"script"</code> 项</li>
</ul>
<p>方法二步骤。</p>
<pre><code>// package.json 配置文件 "script" 中修改 "dev" 项值 "webpack-dev-server" 为 "webpack serve --open Chrome"
</code></pre>
<p>在重新配置完后<code>Terminal</code>输入：<br />
<code>npm run dev</code><br />
经测试，此时可正常实时更新修改的js文件。</p>
<h2 id>结束</h2>
<p>本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh"> CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>


            </section>

        </article>
    </main>
    <footer class="page-footer">
            <amp-img class="site-icon" src="https://zairesinatra.github.io//content/images/2021/07/ghost-orb.png" width="50" height="50" layout="fixed" alt="zairesinatra"></amp-img>
        <h3>zairesinatra</h3>
            <p>The best time to recognize yourself is ten years ago, followed by now.</p>
        <p><a href="../../index.html">Read more posts →</a></p>
        <a class="powered" href="https://ghost.org" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 156 156"><g fill="none" fill-rule="evenodd"><rect fill="#15212B" width="156" height="156" rx="27"/><g transform="translate(36 36)" fill="#F6F8FA"><path d="M0 71.007A4.004 4.004 0 014 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0130 84H4a4 4 0 01-4-4.007v-8.986zM50 71.007A4.004 4.004 0 0154 67h26a4 4 0 014 4.007v8.986A4.004 4.004 0 0180 84H54a4 4 0 01-4-4.007v-8.986z"/><rect y="34" width="84" height="17" rx="4"/><path d="M0 4.007A4.007 4.007 0 014.007 0h41.986A4.003 4.003 0 0150 4.007v8.986A4.007 4.007 0 0145.993 17H4.007A4.003 4.003 0 010 12.993V4.007z"/><rect x="67" width="17" height="17" rx="4"/></g></g></svg> Published with Ghost</a>
    </footer>
    
</body>
</html>
